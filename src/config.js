"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("./index");
const util_1 = require("./lib/util");
const lib_1 = require("node-novel-info/lib");
const util_2 = require("./lib/util");
const uuid_1 = require("./lib/uuid");
class EpubConfig {
    constructor(epubConfig = {}, options = {}) {
        if (epubConfig instanceof EpubConfig) {
            epubConfig = epubConfig.entries(false);
            delete epubConfig.slug;
            delete epubConfig.uuid;
        }
        Object.assign(this, EpubConfig.getDefaultEpubConfig(), lib_1.deepmerge.all([{}, epubConfig, {
                options
            }], lib_1.deepmergeOptions));
    }
    get langMain() {
        return this.lang;
    }
    get subjects() {
        return this.tags;
    }
    set subjects(val) {
        this.tags = val;
    }
    setModification(val, ...argv) {
        let data;
        if (val === true) {
            data = util_1.moment();
        }
        else {
            data = util_1.moment(val, ...argv);
        }
        let self = this;
        self.modification = data.local();
        return this;
    }
    setPublication(val, ...argv) {
        let data;
        if (val === true) {
            data = util_1.moment();
        }
        else {
            data = util_1.moment(val, ...argv);
        }
        let self = this;
        self.publication = data.local();
        return this;
    }
    addAuthor(name, url = null) {
        if (!name) {
            throw new ReferenceError();
        }
        let self = this;
        self.authors = self.authors || {};
        self.authors[name] = url;
        return this;
    }
    addLink(data, rel) {
        rel = (rel || data.rel);
        if (typeof data == 'string') {
            data = {
                href: data.toString(),
                rel,
            };
        }
        let link = Object.assign({
            href: '',
            rel: '',
            id: '',
            refines: '',
            'media-type': '',
        }, data);
        link.href = (link.href || data.href || '').toString();
        link.rel = link.rel || rel || data.rel || 'link-' + util_1.shortid();
        this.links = this.links || [];
        this.links.push(link);
        return this;
    }
    /**
     * isbn:xxx
     * calibre:xxx
     * uuid:xxx
     *
     * @param {string} type
     * @param {string} id
     * @returns {this}
     */
    addIdentifier(type, id) {
        this.identifiers = this.identifiers || [];
        let ids = [];
        if (type && type !== '') {
            ids.push(type.toString());
        }
        if (id && id !== '') {
            ids.push(id.toString());
        }
        if (!ids.length) {
            throw new ReferenceError();
        }
        this.identifiers.push(ids.join(':'));
        return this;
    }
    $clone() {
        // @ts-ignore
        return new (this.__proto__.constructor)(this);
    }
    static $create(epubConfig = {}, options = {}) {
        return new this(epubConfig, options);
    }
    $auto() {
        let self = this;
        self.tags = self.tags || [];
        [
            self.tags,
        ].forEach(a => (a || []).filter(v => v).map(v => v.toString()));
        {
            if (self.authors) {
                self.author = self.author || Object.keys(self.authors)[0];
                self.authorUrl = self.authorUrl || self.authors[self.author];
            }
            if (self.author) {
                let o = {};
                o[self.author] = (self.authorUrl || '').toString();
                self.authors = Object.assign(o, self.authors, o);
            }
            if (self.authors && Object.keys(self.authors).length) {
                for (let name in self.authors) {
                    self.authors[name] = (self.authors[name] || '').toString();
                    self.tags.push(name);
                }
                self.authorsJSON = JSON.stringify(self.authors);
            }
            else {
                self.authors = null;
            }
        }
        if (self.publisher) {
            self.tags.push(self.publisher);
        }
        else {
            self.publisher = 'epub-maker2';
        }
        {
            self.tags.push('epub-maker2');
            if (self.tags) {
                self.tags = util_1.array_unique(self.tags);
            }
        }
        if (self.titles) {
            self.titles = self.titles.filter(v => v && v != self.title && v != self.title_short);
            self.titles = util_1.array_unique(self.titles);
        }
        self.uuid = (self.uuid && typeof self.uuid == 'string') ? self.uuid : uuid_1.createUUID(self);
        self.slug = self.slug
            // @ts-ignore
            || index_1.slugify(self.title)
            || util_1.hashSum(self.title);
        if (!self.modification) {
            self.modification = self.publication.clone();
        }
        if (self.modification) {
            self.modificationDate = self.modification.format('YYYY-MM-DDThh:mm:ss') + 'Z';
            self.modificationDateYMD = self.modification.format('YYYY-MM-DD');
        }
        if (!self.publication) {
            this.setPublication(true);
        }
        if (self.infoPreface) {
            /*
            self.infoPreface = crlf(self.infoPreface).replace(/[ \t\uFEFF\xA0　]+$/gm, '');

            self.infoPrefaceHTML = self.infoPrefaceHTML || self.infoPreface.replace(/\n/g, '<br/>')
            */
            util_2.htmlPreface(self);
        }
        //console.log(self.infoPreface, self.infoPrefaceHTML);
        self.publicationDate = self.publication.format(EpubConfig.dateFormat);
        self.publicationDateYMD = self.publication.format('YYYY-MM-DD');
        if (self.collection || 1) {
            self.collection.name = self.collection.name || self.title;
            self.collection.position = self.collection.position || 1;
            self.collection.type = self.collection.type || 'series';
        }
        return this;
    }
    entries(auto = true) {
        if (auto) {
            this.$auto();
        }
        return Object.entries(this)
            .reduce(function (a, b) {
            a[b[0]] = b[1];
            return a;
        }, {});
    }
    toJSON(auto, replacer = null, space = "\t") {
        if (auto) {
            this.$auto();
        }
        return JSON.stringify(this.entries(), replacer, space);
    }
    toArray(auto) {
        if (auto) {
            this.$auto();
        }
        return Object.entries(this);
    }
}
exports.EpubConfig = EpubConfig;
(function (EpubConfig) {
    EpubConfig.dateFormat = 'YYYY-MM-DDTHH:mm:ss.SSSZ';
    function getDefaultEpubConfig() {
        return {
            toc: [],
            landmarks: [],
            sections: [],
            stylesheet: {},
            additionalFiles: [],
            options: {},
        };
    }
    EpubConfig.getDefaultEpubConfig = getDefaultEpubConfig;
    EpubConfig.defaultEpubConfig = getDefaultEpubConfig();
})(EpubConfig = exports.EpubConfig || (exports.EpubConfig = {}));
//let a = new EpubConfig({lang: 'zh'});
//
//a.addAuthor('菱影代理');
//
//a.setPublication(true);
//
//let b = new EpubConfig(a);
//
//a.lang = 'jp';
//
//console.log(a, b.$auto());
// @ts-ignore
exports.default = EpubConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXVEO0FBQ3ZELHFDQUFvRTtBQUdwRSw2Q0FBa0U7QUFDbEUscUNBQXlDO0FBQ3pDLHFDQUF3QztBQW9IeEMsTUFBYSxVQUFVO0lBb0V0QixZQUFZLGFBQTBCLEVBQUUsRUFBRSxVQUFlLEVBQUU7UUFFMUQsSUFBSSxVQUFVLFlBQVksVUFBVSxFQUNwQztZQUNDLFVBQVUsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXZDLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztZQUN2QixPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUM7U0FDdkI7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsb0JBQW9CLEVBQUUsRUFBRSxlQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRTtnQkFDckYsT0FBTzthQUNQLENBQUMsRUFBRSxzQkFBZ0IsQ0FBQyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksUUFBUTtRQUVYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNsQixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBRVgsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxJQUFJLFFBQVEsQ0FBQyxHQUFhO1FBRXpCLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtRQUUzQixJQUFJLElBQUksQ0FBQztRQUVULElBQUksR0FBRyxLQUFLLElBQUksRUFDaEI7WUFDQyxJQUFJLEdBQUcsYUFBTSxFQUFFLENBQUM7U0FDaEI7YUFFRDtZQUNDLElBQUksR0FBRyxhQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7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Yk1ha2VyLCBJU2x1Z2lmeSwgc2x1Z2lmeSB9IGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IHsgc2hvcnRpZCwgaGFzaFN1bSwgbW9tZW50LCBhcnJheV91bmlxdWUgfSBmcm9tICcuL2xpYi91dGlsJztcbmltcG9ydCB7IGNybGYsIGNoa2NybGYsIExGLCBDUkxGLCBDUiB9IGZyb20gJ2NybGYtbm9ybWFsaXplJztcblxuaW1wb3J0IHsgZGVlcG1lcmdlLCBkZWVwbWVyZ2VPcHRpb25zIH0gZnJvbSAnbm9kZS1ub3ZlbC1pbmZvL2xpYic7XG5pbXBvcnQgeyBodG1sUHJlZmFjZSB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0IHsgY3JlYXRlVVVJRCB9IGZyb20gJy4vbGliL3V1aWQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElDb3ZlciBleHRlbmRzIElGaWxlc1xue1xuXHRyaWdodHM/OiBJUmlnaHRzQ29uZmlnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTdHlsZXNoZWV0IGV4dGVuZHMgSUZpbGVzXG57XG5cdHN0eWxlcz86IHN0cmluZyxcblx0cmVwbGFjZU9yaWdpbmFsPzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmlnaHRzQ29uZmlnXG57XG5cdGRlc2NyaXB0aW9uPzogc3RyaW5nLFxuXHRsaWNlbnNlPzogc3RyaW5nLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElGaWxlc1xue1xuXHR1cmw/OiBzdHJpbmcsXG5cdGZpbGU/OiBzdHJpbmcsXG5cblx0Zm9sZGVyPzogc3RyaW5nLFxuXHRuYW1lPzogc3RyaW5nLFxuXG5cdGJhc2VuYW1lPzogc3RyaW5nLFxuXHRleHQ/OiBzdHJpbmcsXG5cdG1pbWU/OiBzdHJpbmcsXG5cdGRhdGE/O1xuXG5cdGlzPzogc3RyaW5nLFxuXHRocmVmPzogc3RyaW5nLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDb2xsZWN0aW9uXG57XG5cdG5hbWU/OiBzdHJpbmcsXG5cdHR5cGU/OiBzdHJpbmcsXG5cdHBvc2l0aW9uPzogbnVtYmVyLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFcHViQ29uZmlnXG57XG5cdHV1aWQ/OiBzdHJpbmc7XG5cdHRlbXBsYXRlTmFtZT86IHN0cmluZztcblxuXHRmaWxlbmFtZT86IHN0cmluZztcblxuXHR0aXRsZT86IHN0cmluZztcblx0dGl0bGVfc2hvcnQ/OiBzdHJpbmcsXG5cdHRpdGxlcz86IHN0cmluZ1tdO1xuXG5cdHNsdWc/OiBzdHJpbmc7XG5cblx0bGFuZz86IHN0cmluZztcblxuXHRhdXRob3I/OiBzdHJpbmc7XG5cdGF1dGhvclVybD86IHN0cmluZztcblx0YXV0aG9ycz86IHtcblx0XHRbaW5kZXg6IHN0cmluZ106IHN0cmluZyxcblx0fTtcblx0YXV0aG9yc0pTT04/OiBzdHJpbmc7XG5cblx0cHVibGlzaGVyPzogc3RyaW5nO1xuXG5cdHJpZ2h0cz86IElSaWdodHNDb25maWc7XG5cblx0Y292ZXI/OiBJQ292ZXI7XG5cdGN3ZD86IHN0cmluZztcblxuXHRpZGVudGlmaWVycz86IHN0cmluZ1tdO1xuXG5cdGF0dHJpYnV0aW9uVXJsPzogc3RyaW5nO1xuXHRzdHlsZXNoZWV0PzogSVN0eWxlc2hlZXQ7XG5cdHNlY3Rpb25zPzogRXB1Yk1ha2VyLlNlY3Rpb25bXTtcblx0dG9jPzogRXB1Yk1ha2VyLlNlY3Rpb25bXTtcblx0bGFuZG1hcmtzPzogRXB1Yk1ha2VyLlNlY3Rpb25bXTtcblx0b3B0aW9ucz87XG5cdGFkZGl0aW9uYWxGaWxlcz86IElGaWxlc1tdO1xuXG5cdG1vZGlmaWNhdGlvbj86IG1vbWVudC5Nb21lbnQ7XG5cdG1vZGlmaWNhdGlvbkRhdGU/OiBzdHJpbmc7XG5cdG1vZGlmaWNhdGlvbkRhdGVZTUQ/OiBzdHJpbmc7XG5cdHB1YmxpY2F0aW9uPzogbW9tZW50Lk1vbWVudDtcblx0cHVibGljYXRpb25EYXRlPzogc3RyaW5nO1xuXHRwdWJsaWNhdGlvbkRhdGVZTUQ/OiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIDxtZXRhIHByb3BlcnR5PVwiYmVsb25ncy10by1jb2xsZWN0aW9uXCIgaWQ9XCJpZC0yXCI+6buS44Gu6a2U546LV0VCPC9tZXRhPlxuXHQgKiA8bWV0YSByZWZpbmVzPVwiI2lkLTJcIiBwcm9wZXJ0eT1cImNvbGxlY3Rpb24tdHlwZVwiPnNlcmllczwvbWV0YT5cblx0ICogPG1ldGEgcmVmaW5lcz1cIiNpZC0yXCIgcHJvcGVydHk9XCJncm91cC1wb3NpdGlvblwiPjE8L21ldGE+XG5cdCAqL1xuXHRjb2xsZWN0aW9uPzogSUNvbGxlY3Rpb247XG5cblx0LyoqXG5cdCAqIDxkYzpzdWJqZWN0PlxuXHQgKi9cblx0dGFncz86IHN0cmluZ1tdO1xuXG5cdGluZm9QcmVmYWNlPzogc3RyaW5nO1xuXHRpbmZvUHJlZmFjZUhUTUw/OiBzdHJpbmc7XG5cblx0bGlua3M/OiBFcHViTWV0YUxpbmtbXSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFcHViTWV0YUxpbmtcbntcblx0aHJlZjogc3RyaW5nLFxuXHRyZWw6IHN0cmluZyxcblx0aWQ/OiBzdHJpbmcsXG5cdHJlZmluZXM6IHN0cmluZyxcblx0J21lZGlhLXR5cGUnOiBzdHJpbmcsXG59XG5cbmV4cG9ydCBjbGFzcyBFcHViQ29uZmlnIGltcGxlbWVudHMgSUVwdWJDb25maWdcbntcblx0dXVpZD86IHN0cmluZztcblx0dGVtcGxhdGVOYW1lPzogc3RyaW5nO1xuXG5cdGZpbGVuYW1lPzogc3RyaW5nO1xuXG5cdHRpdGxlPzogc3RyaW5nO1xuXHR0aXRsZV9zaG9ydD86IHN0cmluZztcblxuXHR0aXRsZXM/OiBzdHJpbmdbXTtcblxuXHRzbHVnPzogc3RyaW5nO1xuXG5cdGxhbmc/OiBzdHJpbmc7XG5cblx0YXV0aG9yPzogc3RyaW5nO1xuXHRhdXRob3JVcmw/OiBzdHJpbmc7XG5cdGF1dGhvcnM/OiB7XG5cdFx0W2luZGV4OiBzdHJpbmddOiBzdHJpbmcsXG5cdH07XG5cdGF1dGhvcnNKU09OPzogc3RyaW5nO1xuXG5cdHB1Ymxpc2hlcj86IHN0cmluZztcblxuXHRyaWdodHM/OiBJUmlnaHRzQ29uZmlnO1xuXG5cdGNvdmVyPzogSUNvdmVyO1xuXHRjd2Q/OiBzdHJpbmc7XG5cblx0aWRlbnRpZmllcnM/OiBzdHJpbmdbXTtcblxuXHRhdHRyaWJ1dGlvblVybD86IHN0cmluZztcblx0c3R5bGVzaGVldD86IElTdHlsZXNoZWV0O1xuXHRzZWN0aW9ucz86IEVwdWJNYWtlci5TZWN0aW9uW107XG5cdHRvYz86IEVwdWJNYWtlci5TZWN0aW9uW107XG5cdGxhbmRtYXJrcz86IEVwdWJNYWtlci5TZWN0aW9uW107XG5cdG9wdGlvbnM/OiB7XG5cdFx0bGliU2x1Z2lmeT86IElTbHVnaWZ5LFxuXHRcdGV4dD86IHN0cmluZyxcblx0XHRnZW5lcmF0ZU9wdGlvbnM/LFxuXHR9O1xuXHRhZGRpdGlvbmFsRmlsZXM/OiBJRmlsZXNbXTtcblxuXHRtb2RpZmljYXRpb24/OiBtb21lbnQuTW9tZW50O1xuXHRtb2RpZmljYXRpb25EYXRlPzogc3RyaW5nO1xuXHRtb2RpZmljYXRpb25EYXRlWU1EPzogc3RyaW5nO1xuXHRwdWJsaWNhdGlvbj86IG1vbWVudC5Nb21lbnQ7XG5cdHB1YmxpY2F0aW9uRGF0ZT86IHN0cmluZztcblx0cHVibGljYXRpb25EYXRlWU1EPzogc3RyaW5nO1xuXG5cdC8qKlxuXHQgKiA8bWV0YSBwcm9wZXJ0eT1cImJlbG9uZ3MtdG8tY29sbGVjdGlvblwiIGlkPVwiaWQtMlwiPum7kuOBrumtlOeOi1dFQjwvbWV0YT5cblx0ICogPG1ldGEgcmVmaW5lcz1cIiNpZC0yXCIgcHJvcGVydHk9XCJjb2xsZWN0aW9uLXR5cGVcIj5zZXJpZXM8L21ldGE+XG5cdCAqIDxtZXRhIHJlZmluZXM9XCIjaWQtMlwiIHByb3BlcnR5PVwiZ3JvdXAtcG9zaXRpb25cIj4xPC9tZXRhPlxuXHQgKi9cblx0Y29sbGVjdGlvbj86IElDb2xsZWN0aW9uO1xuXG5cdC8qKlxuXHQgKiA8ZGM6c3ViamVjdD5cblx0ICovXG5cdHRhZ3M/OiBzdHJpbmdbXTtcblxuXHRpbmZvUHJlZmFjZT86IHN0cmluZztcblx0aW5mb1ByZWZhY2VIVE1MPzogc3RyaW5nO1xuXG5cdGxpbmtzPzogRXB1Yk1ldGFMaW5rW107XG5cblx0Y29uc3RydWN0b3IoZXB1YkNvbmZpZzogSUVwdWJDb25maWcgPSB7fSwgb3B0aW9uczogYW55ID0ge30pXG5cdHtcblx0XHRpZiAoZXB1YkNvbmZpZyBpbnN0YW5jZW9mIEVwdWJDb25maWcpXG5cdFx0e1xuXHRcdFx0ZXB1YkNvbmZpZyA9IGVwdWJDb25maWcuZW50cmllcyhmYWxzZSk7XG5cblx0XHRcdGRlbGV0ZSBlcHViQ29uZmlnLnNsdWc7XG5cdFx0XHRkZWxldGUgZXB1YkNvbmZpZy51dWlkO1xuXHRcdH1cblxuXHRcdE9iamVjdC5hc3NpZ24odGhpcywgRXB1YkNvbmZpZy5nZXREZWZhdWx0RXB1YkNvbmZpZygpLCBkZWVwbWVyZ2UuYWxsKFt7fSwgZXB1YkNvbmZpZywge1xuXHRcdFx0b3B0aW9uc1xuXHRcdH1dLCBkZWVwbWVyZ2VPcHRpb25zKSk7XG5cdH1cblxuXHRnZXQgbGFuZ01haW4oKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMubGFuZztcblx0fVxuXG5cdGdldCBzdWJqZWN0cygpOiBzdHJpbmdbXVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMudGFncztcblx0fVxuXG5cdHNldCBzdWJqZWN0cyh2YWw6IHN0cmluZ1tdKVxuXHR7XG5cdFx0dGhpcy50YWdzID0gdmFsO1xuXHR9XG5cblx0c2V0TW9kaWZpY2F0aW9uKHZhbCwgLi4uYXJndilcblx0e1xuXHRcdGxldCBkYXRhO1xuXG5cdFx0aWYgKHZhbCA9PT0gdHJ1ZSlcblx0XHR7XG5cdFx0XHRkYXRhID0gbW9tZW50KCk7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRkYXRhID0gbW9tZW50KHZhbCwgLi4uYXJndik7XG5cdFx0fVxuXG5cdFx0bGV0IHNlbGYgPSB0aGlzIGFzIElFcHViQ29uZmlnO1xuXHRcdHNlbGYubW9kaWZpY2F0aW9uID0gZGF0YS5sb2NhbCgpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzZXRQdWJsaWNhdGlvbih2YWwsIC4uLmFyZ3YpXG5cdHtcblx0XHRsZXQgZGF0YTtcblxuXHRcdGlmICh2YWwgPT09IHRydWUpXG5cdFx0e1xuXHRcdFx0ZGF0YSA9IG1vbWVudCgpO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0ZGF0YSA9IG1vbWVudCh2YWwsIC4uLmFyZ3YpO1xuXHRcdH1cblxuXHRcdGxldCBzZWxmID0gdGhpcyBhcyBJRXB1YkNvbmZpZztcblx0XHRzZWxmLnB1YmxpY2F0aW9uID0gZGF0YS5sb2NhbCgpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhZGRBdXRob3IobmFtZTogc3RyaW5nLCB1cmw6IHN0cmluZyA9IG51bGwpXG5cdHtcblx0XHRpZiAoIW5hbWUpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCk7XG5cdFx0fVxuXG5cdFx0bGV0IHNlbGYgPSB0aGlzIGFzIElFcHViQ29uZmlnO1xuXG5cdFx0c2VsZi5hdXRob3JzID0gc2VsZi5hdXRob3JzIHx8IHt9O1xuXG5cdFx0c2VsZi5hdXRob3JzW25hbWVdID0gdXJsO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhZGRMaW5rKGRhdGE6IEVwdWJNZXRhTGluayB8IHN0cmluZywgcmVsPzogc3RyaW5nKVxuXHR7XG5cdFx0cmVsID0gKHJlbCB8fCAoPEVwdWJNZXRhTGluaz5kYXRhKS5yZWwpIGFzIHN0cmluZztcblxuXHRcdGlmICh0eXBlb2YgZGF0YSA9PSAnc3RyaW5nJylcblx0XHR7XG5cdFx0XHRkYXRhID0ge1xuXHRcdFx0XHRocmVmOiBkYXRhLnRvU3RyaW5nKCksXG5cdFx0XHRcdHJlbCxcblx0XHRcdH0gYXMgRXB1Yk1ldGFMaW5rO1xuXHRcdH1cblxuXHRcdGxldCBsaW5rID0gT2JqZWN0LmFzc2lnbih7XG5cdFx0XHRocmVmOiAnJyxcblx0XHRcdHJlbDogJycsXG5cdFx0XHRpZDogJycsXG5cdFx0XHRyZWZpbmVzOiAnJyxcblx0XHRcdCdtZWRpYS10eXBlJzogJycsXG5cdFx0fSBhcyBFcHViTWV0YUxpbmssIGRhdGEpO1xuXG5cdFx0bGluay5ocmVmID0gKGxpbmsuaHJlZiB8fCBkYXRhLmhyZWYgfHwgJycpLnRvU3RyaW5nKCk7XG5cdFx0bGluay5yZWwgPSBsaW5rLnJlbCB8fCByZWwgfHwgZGF0YS5yZWwgfHwgJ2xpbmstJyArIHNob3J0aWQoKTtcblxuXHRcdHRoaXMubGlua3MgPSB0aGlzLmxpbmtzIHx8IFtdO1xuXHRcdHRoaXMubGlua3MucHVzaChsaW5rKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIGlzYm46eHh4XG5cdCAqIGNhbGlicmU6eHh4XG5cdCAqIHV1aWQ6eHh4XG5cdCAqXG5cdCAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlXG5cdCAqIEBwYXJhbSB7c3RyaW5nfSBpZFxuXHQgKiBAcmV0dXJucyB7dGhpc31cblx0ICovXG5cdGFkZElkZW50aWZpZXIodHlwZTogc3RyaW5nLCBpZD86IHN0cmluZylcblx0e1xuXHRcdHRoaXMuaWRlbnRpZmllcnMgPSB0aGlzLmlkZW50aWZpZXJzIHx8IFtdO1xuXG5cdFx0bGV0IGlkcyA9IFtdO1xuXG5cdFx0aWYgKHR5cGUgJiYgdHlwZSAhPT0gJycpXG5cdFx0e1xuXHRcdFx0aWRzLnB1c2godHlwZS50b1N0cmluZygpKTtcblx0XHR9XG5cdFx0aWYgKGlkICYmIGlkICE9PSAnJylcblx0XHR7XG5cdFx0XHRpZHMucHVzaChpZC50b1N0cmluZygpKTtcblx0XHR9XG5cblx0XHRpZiAoIWlkcy5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5pZGVudGlmaWVycy5wdXNoKGlkcy5qb2luKCc6JykpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQkY2xvbmUoKVxuXHR7XG5cdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdHJldHVybiBuZXcgKHRoaXMuX19wcm90b19fLmNvbnN0cnVjdG9yKSh0aGlzKTtcblx0fVxuXG5cdHN0YXRpYyAkY3JlYXRlKGVwdWJDb25maWc6IElFcHViQ29uZmlnID0ge30sIG9wdGlvbnM6IGFueSA9IHt9KVxuXHR7XG5cdFx0cmV0dXJuIG5ldyB0aGlzKGVwdWJDb25maWcsIG9wdGlvbnMpXG5cdH1cblxuXHQkYXV0bygpXG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXMgYXMgSUVwdWJDb25maWc7XG5cblx0XHRzZWxmLnRhZ3MgPSBzZWxmLnRhZ3MgfHwgW107XG5cblx0XHRbXG5cdFx0XHRzZWxmLnRhZ3MsXG5cdFx0XS5mb3JFYWNoKGEgPT4gKGEgfHwgW10pLmZpbHRlcih2ID0+IHYpLm1hcCh2ID0+IHYudG9TdHJpbmcoKSkpO1xuXG5cdFx0e1xuXHRcdFx0aWYgKHNlbGYuYXV0aG9ycylcblx0XHRcdHtcblx0XHRcdFx0c2VsZi5hdXRob3IgPSBzZWxmLmF1dGhvciB8fCBPYmplY3Qua2V5cyhzZWxmLmF1dGhvcnMpWzBdO1xuXHRcdFx0XHRzZWxmLmF1dGhvclVybCA9IHNlbGYuYXV0aG9yVXJsIHx8IHNlbGYuYXV0aG9yc1tzZWxmLmF1dGhvcl07XG5cdFx0XHR9XG5cblx0XHRcdGlmIChzZWxmLmF1dGhvcilcblx0XHRcdHtcblx0XHRcdFx0bGV0IG8gPSB7fTtcblxuXHRcdFx0XHRvW3NlbGYuYXV0aG9yXSA9IChzZWxmLmF1dGhvclVybCB8fCAnJykudG9TdHJpbmcoKTtcblxuXHRcdFx0XHRzZWxmLmF1dGhvcnMgPSBPYmplY3QuYXNzaWduKG8sIHNlbGYuYXV0aG9ycywgbyk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChzZWxmLmF1dGhvcnMgJiYgT2JqZWN0LmtleXMoc2VsZi5hdXRob3JzKS5sZW5ndGgpXG5cdFx0XHR7XG5cdFx0XHRcdGZvciAobGV0IG5hbWUgaW4gc2VsZi5hdXRob3JzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0c2VsZi5hdXRob3JzW25hbWVdID0gKHNlbGYuYXV0aG9yc1tuYW1lXSB8fCAnJykudG9TdHJpbmcoKTtcblxuXHRcdFx0XHRcdHNlbGYudGFncy5wdXNoKG5hbWUpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0c2VsZi5hdXRob3JzSlNPTiA9IEpTT04uc3RyaW5naWZ5KHNlbGYuYXV0aG9ycyk7XG5cdFx0XHR9XG5cdFx0XHRlbHNlXG5cdFx0XHR7XG5cdFx0XHRcdHNlbGYuYXV0aG9ycyA9IG51bGw7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKHNlbGYucHVibGlzaGVyKVxuXHRcdHtcblx0XHRcdHNlbGYudGFncy5wdXNoKHNlbGYucHVibGlzaGVyKTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHNlbGYucHVibGlzaGVyID0gJ2VwdWItbWFrZXIyJztcblx0XHR9XG5cblx0XHR7XG5cdFx0XHRzZWxmLnRhZ3MucHVzaCgnZXB1Yi1tYWtlcjInKTtcblxuXHRcdFx0aWYgKHNlbGYudGFncylcblx0XHRcdHtcblx0XHRcdFx0c2VsZi50YWdzID0gYXJyYXlfdW5pcXVlKHNlbGYudGFncyk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKHNlbGYudGl0bGVzKVxuXHRcdHtcblx0XHRcdHNlbGYudGl0bGVzID0gc2VsZi50aXRsZXMuZmlsdGVyKHYgPT4gdiAmJiB2ICE9IHNlbGYudGl0bGUgJiYgdiAhPSBzZWxmLnRpdGxlX3Nob3J0KTtcblxuXHRcdFx0c2VsZi50aXRsZXMgPSBhcnJheV91bmlxdWUoc2VsZi50aXRsZXMpO1xuXHRcdH1cblxuXHRcdHNlbGYudXVpZCA9IChzZWxmLnV1aWQgJiYgdHlwZW9mIHNlbGYudXVpZCA9PSAnc3RyaW5nJykgPyBzZWxmLnV1aWQgOiBjcmVhdGVVVUlEKHNlbGYpO1xuXHRcdHNlbGYuc2x1ZyA9IHNlbGYuc2x1Z1xuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0fHwgc2x1Z2lmeShzZWxmLnRpdGxlKVxuXHRcdFx0fHwgaGFzaFN1bShzZWxmLnRpdGxlKVxuXHRcdDtcblxuXHRcdGlmICghc2VsZi5tb2RpZmljYXRpb24pXG5cdFx0e1xuXHRcdFx0c2VsZi5tb2RpZmljYXRpb24gPSBzZWxmLnB1YmxpY2F0aW9uLmNsb25lKCk7XG5cdFx0fVxuXG5cdFx0aWYgKHNlbGYubW9kaWZpY2F0aW9uKVxuXHRcdHtcblx0XHRcdHNlbGYubW9kaWZpY2F0aW9uRGF0ZSA9IHNlbGYubW9kaWZpY2F0aW9uLmZvcm1hdCgnWVlZWS1NTS1ERFRoaDptbTpzcycpICsgJ1onO1xuXHRcdFx0c2VsZi5tb2RpZmljYXRpb25EYXRlWU1EID0gc2VsZi5tb2RpZmljYXRpb24uZm9ybWF0KCdZWVlZLU1NLUREJyk7XG5cdFx0fVxuXG5cdFx0aWYgKCFzZWxmLnB1YmxpY2F0aW9uKVxuXHRcdHtcblx0XHRcdHRoaXMuc2V0UHVibGljYXRpb24odHJ1ZSk7XG5cdFx0fVxuXG5cdFx0aWYgKHNlbGYuaW5mb1ByZWZhY2UpXG5cdFx0e1xuXHRcdFx0Lypcblx0XHRcdHNlbGYuaW5mb1ByZWZhY2UgPSBjcmxmKHNlbGYuaW5mb1ByZWZhY2UpLnJlcGxhY2UoL1sgXFx0XFx1RkVGRlxceEEw44CAXSskL2dtLCAnJyk7XG5cblx0XHRcdHNlbGYuaW5mb1ByZWZhY2VIVE1MID0gc2VsZi5pbmZvUHJlZmFjZUhUTUwgfHwgc2VsZi5pbmZvUHJlZmFjZS5yZXBsYWNlKC9cXG4vZywgJzxici8+Jylcblx0XHRcdCovXG5cdFx0XHRodG1sUHJlZmFjZShzZWxmKTtcblx0XHR9XG5cblx0XHQvL2NvbnNvbGUubG9nKHNlbGYuaW5mb1ByZWZhY2UsIHNlbGYuaW5mb1ByZWZhY2VIVE1MKTtcblxuXHRcdHNlbGYucHVibGljYXRpb25EYXRlID0gc2VsZi5wdWJsaWNhdGlvbi5mb3JtYXQoRXB1YkNvbmZpZy5kYXRlRm9ybWF0KTtcblx0XHRzZWxmLnB1YmxpY2F0aW9uRGF0ZVlNRCA9IHNlbGYucHVibGljYXRpb24uZm9ybWF0KCdZWVlZLU1NLUREJyk7XG5cblx0XHRpZiAoc2VsZi5jb2xsZWN0aW9uIHx8IDEpXG5cdFx0e1xuXHRcdFx0c2VsZi5jb2xsZWN0aW9uLm5hbWUgPSBzZWxmLmNvbGxlY3Rpb24ubmFtZSB8fCBzZWxmLnRpdGxlO1xuXHRcdFx0c2VsZi5jb2xsZWN0aW9uLnBvc2l0aW9uID0gc2VsZi5jb2xsZWN0aW9uLnBvc2l0aW9uIHx8IDE7XG5cdFx0XHRzZWxmLmNvbGxlY3Rpb24udHlwZSA9IHNlbGYuY29sbGVjdGlvbi50eXBlIHx8ICdzZXJpZXMnO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0ZW50cmllcyhhdXRvID0gdHJ1ZSk6IElFcHViQ29uZmlnXG5cdHtcblx0XHRpZiAoYXV0bylcblx0XHR7XG5cdFx0XHR0aGlzLiRhdXRvKCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIE9iamVjdC5lbnRyaWVzKHRoaXMpXG5cdFx0XHQucmVkdWNlKGZ1bmN0aW9uIChhLCBiKVxuXHRcdFx0e1xuXHRcdFx0XHRhW2JbMF1dID0gYlsxXTtcblxuXHRcdFx0XHRyZXR1cm4gYTtcblx0XHRcdH0sIHt9KVxuXHRcdDtcblx0fVxuXG5cdHRvSlNPTihhdXRvPzogYm9vbGVhbiwgcmVwbGFjZXIgPSBudWxsLCBzcGFjZSA9IFwiXFx0XCIpOiBzdHJpbmdcblx0e1xuXHRcdGlmIChhdXRvKVxuXHRcdHtcblx0XHRcdHRoaXMuJGF1dG8oKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy5lbnRyaWVzKCksIHJlcGxhY2VyLCBzcGFjZSk7XG5cdH1cblxuXHR0b0FycmF5KGF1dG8/OiBib29sZWFuKVxuXHR7XG5cdFx0aWYgKGF1dG8pXG5cdFx0e1xuXHRcdFx0dGhpcy4kYXV0bygpO1xuXHRcdH1cblxuXHRcdHJldHVybiBPYmplY3QuZW50cmllcyh0aGlzKTtcblx0fVxufVxuXG5leHBvcnQgbmFtZXNwYWNlIEVwdWJDb25maWdcbntcblx0ZXhwb3J0IGxldCBkYXRlRm9ybWF0ID0gJ1lZWVktTU0tRERUSEg6bW06c3MuU1NTWic7XG5cblx0ZXhwb3J0IGZ1bmN0aW9uIGdldERlZmF1bHRFcHViQ29uZmlnKClcblx0e1xuXHRcdHJldHVybiB7XG5cdFx0XHR0b2M6IFtdLFxuXHRcdFx0bGFuZG1hcmtzOiBbXSxcblx0XHRcdHNlY3Rpb25zOiBbXSxcblx0XHRcdHN0eWxlc2hlZXQ6IHt9LFxuXHRcdFx0YWRkaXRpb25hbEZpbGVzOiBbXSxcblx0XHRcdG9wdGlvbnM6IHt9LFxuXHRcdH07XG5cdH1cblxuXHRleHBvcnQgbGV0IGRlZmF1bHRFcHViQ29uZmlnID0gZ2V0RGVmYXVsdEVwdWJDb25maWcoKTtcbn1cblxuLy9sZXQgYSA9IG5ldyBFcHViQ29uZmlnKHtsYW5nOiAnemgnfSk7XG4vL1xuLy9hLmFkZEF1dGhvcign6I+x5b2x5Luj55CGJyk7XG4vL1xuLy9hLnNldFB1YmxpY2F0aW9uKHRydWUpO1xuLy9cbi8vbGV0IGIgPSBuZXcgRXB1YkNvbmZpZyhhKTtcbi8vXG4vL2EubGFuZyA9ICdqcCc7XG4vL1xuLy9jb25zb2xlLmxvZyhhLCBiLiRhdXRvKCkpO1xuXG4vLyBAdHMtaWdub3JlXG5leHBvcnQgZGVmYXVsdCBFcHViQ29uZmlnIGFzIEVwdWJDb25maWc7XG4iXX0=