"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const moment = require("moment");
const index_1 = require("./index");
const shortid = require("shortid");
const hashSum = require("hash-sum");
const array_1 = require("./lib/array");
const lib_1 = require("node-novel-info/lib");
const util_1 = require("./lib/util");
const uuid_1 = require("./lib/uuid");
class EpubConfig {
    constructor(epubConfig = {}, options = {}) {
        if (epubConfig instanceof EpubConfig) {
            epubConfig = epubConfig.entries(false);
            delete epubConfig.slug;
            delete epubConfig.uuid;
        }
        Object.assign(this, EpubConfig.getDefaultEpubConfig(), lib_1.deepmerge.all([{}, epubConfig, {
                options
            }], lib_1.deepmergeOptions));
    }
    get langMain() {
        return this.lang;
    }
    get subjects() {
        return this.tags;
    }
    set subjects(val) {
        this.tags = val;
    }
    setModification(val, ...argv) {
        let data;
        if (val === true) {
            data = moment();
        }
        else {
            data = moment(val, ...argv);
        }
        let self = this;
        self.modification = data.local();
        return this;
    }
    setPublication(val, ...argv) {
        let data;
        if (val === true) {
            data = moment();
        }
        else {
            data = moment(val, ...argv);
        }
        let self = this;
        self.publication = data.local();
        return this;
    }
    addAuthor(name, url = null) {
        if (!name) {
            throw new ReferenceError();
        }
        let self = this;
        self.authors = self.authors || {};
        self.authors[name] = url;
        return this;
    }
    addLink(data, rel) {
        rel = (rel || data.rel);
        if (typeof data == 'string') {
            data = {
                href: data.toString(),
                rel,
            };
        }
        let link = Object.assign({
            href: '',
            rel: '',
            id: '',
            refines: '',
            'media-type': '',
        }, data);
        link.href = (link.href || data.href || '').toString();
        link.rel = link.rel || rel || data.rel || 'link-' + shortid();
        this.links = this.links || [];
        this.links.push(link);
        return this;
    }
    /**
     * isbn:xxx
     * calibre:xxx
     * uuid:xxx
     *
     * @param {string} type
     * @param {string} id
     * @returns {this}
     */
    addIdentifier(type, id) {
        this.identifiers = this.identifiers || [];
        let ids = [];
        if (type && type !== '') {
            ids.push(type.toString());
        }
        if (id && id !== '') {
            ids.push(id.toString());
        }
        if (!ids.length) {
            throw new ReferenceError();
        }
        this.identifiers.push(ids.join(':'));
        return this;
    }
    $clone() {
        // @ts-ignore
        return new (this.__proto__.constructor)(this);
    }
    static $create(epubConfig = {}, options = {}) {
        return new this(epubConfig, options);
    }
    $auto() {
        let self = this;
        self.tags = self.tags || [];
        [
            self.tags,
        ].forEach(a => (a || []).filter(v => v).map(v => v.toString()));
        {
            if (self.authors) {
                self.author = self.author || Object.keys(self.authors)[0];
                self.authorUrl = self.authorUrl || self.authors[self.author];
            }
            if (self.author) {
                let o = {};
                o[self.author] = (self.authorUrl || '').toString();
                self.authors = Object.assign(o, self.authors, o);
            }
            if (self.authors && Object.keys(self.authors).length) {
                for (let name in self.authors) {
                    self.authors[name] = (self.authors[name] || '').toString();
                    self.tags.push(name);
                }
                self.authorsJSON = JSON.stringify(self.authors);
            }
            else {
                self.authors = null;
            }
        }
        if (self.publisher) {
            self.tags.push(self.publisher);
        }
        else {
            self.publisher = 'epub-maker2';
        }
        {
            self.tags.push('epub-maker2');
            if (self.tags) {
                self.tags = array_1.array_unique(self.tags);
            }
        }
        if (self.titles) {
            self.titles = self.titles.filter(v => v && v != self.title && v != self.title_short);
            self.titles = array_1.array_unique(self.titles);
        }
        self.uuid = (self.uuid && typeof self.uuid == 'string') ? self.uuid : uuid_1.createUUID(self);
        self.slug = self.slug
            // @ts-ignore
            || index_1.slugify(self.title)
            || hashSum(self.title);
        if (!self.modification) {
            self.modification = self.publication.clone();
        }
        if (self.modification) {
            self.modificationDate = self.modification.format('YYYY-MM-DDThh:mm:ss') + 'Z';
            self.modificationDateYMD = self.modification.format('YYYY-MM-DD');
        }
        if (!self.publication) {
            this.setPublication(true);
        }
        if (self.infoPreface) {
            /*
            self.infoPreface = crlf(self.infoPreface).replace(/[ \t\uFEFF\xA0　]+$/gm, '');

            self.infoPrefaceHTML = self.infoPrefaceHTML || self.infoPreface.replace(/\n/g, '<br/>')
            */
            util_1.htmlPreface(self);
        }
        //console.log(self.infoPreface, self.infoPrefaceHTML);
        self.publicationDate = self.publication.format(EpubConfig.dateFormat);
        self.publicationDateYMD = self.publication.format('YYYY-MM-DD');
        if (self.collection || 1) {
            self.collection.name = self.collection.name || self.title;
            self.collection.position = self.collection.position || 1;
            self.collection.type = self.collection.type || 'series';
        }
        return this;
    }
    entries(auto = true) {
        if (auto) {
            this.$auto();
        }
        return Object.entries(this)
            .reduce(function (a, b) {
            a[b[0]] = b[1];
            return a;
        }, {});
    }
    toJSON(auto, replacer = null, space = "\t") {
        if (auto) {
            this.$auto();
        }
        return JSON.stringify(this.entries(), replacer, space);
    }
    toArray(auto) {
        if (auto) {
            this.$auto();
        }
        return Object.entries(this);
    }
}
exports.EpubConfig = EpubConfig;
(function (EpubConfig) {
    EpubConfig.dateFormat = 'YYYY-MM-DDTHH:mm:ss.SSSZ';
    function getDefaultEpubConfig() {
        return {
            toc: [],
            landmarks: [],
            sections: [],
            stylesheet: {},
            additionalFiles: [],
            options: {},
        };
    }
    EpubConfig.getDefaultEpubConfig = getDefaultEpubConfig;
    EpubConfig.defaultEpubConfig = getDefaultEpubConfig();
})(EpubConfig = exports.EpubConfig || (exports.EpubConfig = {}));
//let a = new EpubConfig({lang: 'zh'});
//
//a.addAuthor('菱影代理');
//
//a.setPublication(true);
//
//let b = new EpubConfig(a);
//
//a.lang = 'jp';
//
//console.log(a, b.$auto());
// @ts-ignore
exports.default = EpubConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29uZmlnLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUNBQWlDO0FBQ2pDLG1DQUF1RDtBQUN2RCxtQ0FBbUM7QUFDbkMsb0NBQW9DO0FBQ3BDLHVDQUEyQztBQUczQyw2Q0FBa0U7QUFDbEUscUNBQXlDO0FBQ3pDLHFDQUF3QztBQW9IeEMsTUFBYSxVQUFVO0lBb0V0QixZQUFZLGFBQTBCLEVBQUUsRUFBRSxVQUFlLEVBQUU7UUFFMUQsSUFBSSxVQUFVLFlBQVksVUFBVSxFQUNwQztZQUNDLFVBQVUsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXZDLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztZQUN2QixPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUM7U0FDdkI7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsb0JBQW9CLEVBQUUsRUFBRSxlQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRTtnQkFDckYsT0FBTzthQUNQLENBQUMsRUFBRSxzQkFBZ0IsQ0FBQyxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQUksUUFBUTtRQUVYLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNsQixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBRVgsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxJQUFJLFFBQVEsQ0FBQyxHQUFhO1FBRXpCLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxlQUFlLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtRQUUzQixJQUFJLElBQUksQ0FBQztRQUVULElBQUksR0FBRyxLQUFLLElBQUksRUFDaEI7WUFDQyxJQUFJLEdBQUcsTUFBTSxFQUFFLENBQUM7U0FDaEI7YUFFRDtZQUNDLElBQUksR0FBRyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDNUI7UUFFRCxJQUFJLElBQUksR0FBRyxJQUFtQixDQUFDO1FBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRWpDLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELGNBQWMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJO1FBRTFCLElBQUksSUFBSSxDQUFDO1FBRVQsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUNoQjtZQUNDLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQztTQUNoQjthQUVEO1lBQ0MsSUFBSSxHQUFHLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztTQUM1QjtRQUVELElBQUksSUFBSSxHQUFHLElBQW1CLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFaEMsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsU0FBUyxDQUFDLElBQVksRUFBRSxNQUFjLElBQUk7UUFFekMsSUFBSSxDQUFDLElBQUksRUFDVDtZQUNDLE1BQU0sSUFBSSxjQUFjLEVBQUUsQ0FBQztTQUMzQjtRQUVELElBQUksSUFBSSxHQUFHLElBQW1CLENBQUM7UUFFL0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUVsQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUV6QixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBMkIsRUFBRSxHQUFZO1FBRWhELEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBbUIsSUFBSyxDQUFDLEdBQUcsQ0FBVyxDQUFDO1FBRWxELElBQUksT0FBTyxJQUFJLElBQUksUUFBUSxFQUMzQjtZQUNDLElBQUksR0FBRztnQkFDTixJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDckIsR0FBRzthQUNhLENBQUM7U0FDbEI7UUFFRCxJQUFJLElBQUksR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ3hCLElBQUksRUFBRSxFQUFFO1lBQ1IsR0FBRyxFQUFFLEVBQUU7WUFDUCxFQUFFLEVBQUUsRUFBRTtZQUNOLE9BQU8sRUFBRSxFQUFFO1lBQ1gsWUFBWSxFQUFFLEVBQUU7U0FDQSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRXpCLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDdEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLE9BQU8sR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUU5RCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRCLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsYUFBYSxDQUFDLElBQVksRUFBRSxFQUFXO1FBRXRDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7UUFFMUMsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBRWIsSUFBSSxJQUFJLElBQUksSUFBSSxLQUFLLEVBQUUsRUFDdkI7WUFDQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO1FBQ0QsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFDbkI7WUFDQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQ2Y7WUFDQyxNQUFNLElBQUksY0FBYyxFQUFFLENBQUM7U0FDM0I7UUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFckMsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsTUFBTTtRQUVMLGFBQWE7UUFDYixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQTBCLEVBQUUsRUFBRSxVQUFlLEVBQUU7UUFFN0QsT0FBTyxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDckMsQ0FBQztJQUVELEtBQUs7UUFFSixJQUFJLElBQUksR0FBRyxJQUFtQixDQUFDO1FBRS9CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFFNUI7WUFDQyxJQUFJLENBQUMsSUFBSTtTQUNULENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUVoRTtZQUNDLElBQUksSUFBSSxDQUFDLE9BQU8sRUFDaEI7Z0JBQ0MsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMxRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDN0Q7WUFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQ2Y7Z0JBQ0MsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUVYLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUVuRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDakQ7WUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUNwRDtnQkFDQyxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQzdCO29CQUNDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUUzRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDckI7Z0JBRUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNoRDtpQkFFRDtnQkFDQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQzthQUNwQjtTQUNEO1FBRUQsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUNsQjtZQUNDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUMvQjthQUVEO1lBQ0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxhQUFhLENBQUM7U0FDL0I7UUFFRDtZQUNDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRTlCLElBQUksSUFBSSxDQUFDLElBQUksRUFDYjtnQkFDQyxJQUFJLENBQUMsSUFBSSxHQUFHLG9CQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3BDO1NBQ0Q7UUFFRCxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQ2Y7WUFDQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFckYsSUFBSSxDQUFDLE1BQU0sR0FBRyxvQkFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN4QztRQUVELElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsaUJBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJO1lBQ3BCLGFBQWE7ZUFDVixlQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztlQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUN0QjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUN0QjtZQUNDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUM3QztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksRUFDckI7WUFDQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsR0FBRyxHQUFHLENBQUM7WUFDOUUsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ2xFO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQ3JCO1lBQ0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQjtRQUVELElBQUksSUFBSSxDQUFDLFdBQVcsRUFDcEI7WUFDQzs7OztjQUlFO1lBQ0Ysa0JBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNsQjtRQUVELHNEQUFzRDtRQUV0RCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFaEUsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsRUFDeEI7WUFDQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQzFELElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQztZQUN6RCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUM7U0FDeEQ7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUk7UUFFbEIsSUFBSSxJQUFJLEVBQ1I7WUFDQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDYjtRQUVELE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7YUFDekIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFFckIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVmLE9BQU8sQ0FBQyxDQUFDO1FBQ1YsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUNOO0lBQ0YsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFjLEVBQUUsUUFBUSxHQUFHLElBQUksRUFBRSxLQUFLLEdBQUcsSUFBSTtRQUVuRCxJQUFJLElBQUksRUFDUjtZQUNDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNiO1FBRUQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFjO1FBRXJCLElBQUksSUFBSSxFQUNSO1lBQ0MsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2I7UUFFRCxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztDQUNEO0FBMVhELGdDQTBYQztBQUVELFdBQWlCLFVBQVU7SUFFZixxQkFBVSxHQUFHLDBCQUEwQixDQUFDO0lBRW5ELFNBQWdCLG9CQUFvQjtRQUVuQyxPQUFPO1lBQ04sR0FBRyxFQUFFLEVBQUU7WUFDUCxTQUFTLEVBQUUsRUFBRTtZQUNiLFFBQVEsRUFBRSxFQUFFO1lBQ1osVUFBVSxFQUFFLEVBQUU7WUFDZCxlQUFlLEVBQUUsRUFBRTtZQUNuQixPQUFPLEVBQUUsRUFBRTtTQUNYLENBQUM7SUFDSCxDQUFDO0lBVmUsK0JBQW9CLHVCQVVuQyxDQUFBO0lBRVUsNEJBQWlCLEdBQUcsb0JBQW9CLEVBQUUsQ0FBQztBQUN2RCxDQUFDLEVBakJnQixVQUFVLEdBQVYsa0JBQVUsS0FBVixrQkFBVSxRQWlCMUI7QUFFRCx1Q0FBdUM7QUFDdkMsRUFBRTtBQUNGLHNCQUFzQjtBQUN0QixFQUFFO0FBQ0YseUJBQXlCO0FBQ3pCLEVBQUU7QUFDRiw0QkFBNEI7QUFDNUIsRUFBRTtBQUNGLGdCQUFnQjtBQUNoQixFQUFFO0FBQ0YsNEJBQTRCO0FBRTVCLGFBQWE7QUFDYixrQkFBZSxVQUF3QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbW9tZW50IGZyb20gJ21vbWVudCc7XHJcbmltcG9ydCB7IEVwdWJNYWtlciwgSVNsdWdpZnksIHNsdWdpZnkgfSBmcm9tICcuL2luZGV4JztcclxuaW1wb3J0ICogYXMgc2hvcnRpZCBmcm9tICdzaG9ydGlkJztcclxuaW1wb3J0ICogYXMgaGFzaFN1bSBmcm9tICdoYXNoLXN1bSc7XHJcbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJy4vbGliL2FycmF5JztcclxuaW1wb3J0IHsgY3JsZiwgY2hrY3JsZiwgTEYsIENSTEYsIENSIH0gZnJvbSAnY3JsZi1ub3JtYWxpemUnO1xyXG5cclxuaW1wb3J0IHsgZGVlcG1lcmdlLCBkZWVwbWVyZ2VPcHRpb25zIH0gZnJvbSAnbm9kZS1ub3ZlbC1pbmZvL2xpYic7XHJcbmltcG9ydCB7IGh0bWxQcmVmYWNlIH0gZnJvbSAnLi9saWIvdXRpbCc7XHJcbmltcG9ydCB7IGNyZWF0ZVVVSUQgfSBmcm9tICcuL2xpYi91dWlkJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUNvdmVyIGV4dGVuZHMgSUZpbGVzXHJcbntcclxuXHRyaWdodHM/OiBJUmlnaHRzQ29uZmlnLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElTdHlsZXNoZWV0IGV4dGVuZHMgSUZpbGVzXHJcbntcclxuXHRzdHlsZXM/OiBzdHJpbmcsXHJcblx0cmVwbGFjZU9yaWdpbmFsPzogYm9vbGVhbixcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJUmlnaHRzQ29uZmlnXHJcbntcclxuXHRkZXNjcmlwdGlvbj86IHN0cmluZyxcclxuXHRsaWNlbnNlPzogc3RyaW5nLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElGaWxlc1xyXG57XHJcblx0dXJsPzogc3RyaW5nLFxyXG5cdGZpbGU/OiBzdHJpbmcsXHJcblxyXG5cdGZvbGRlcj86IHN0cmluZyxcclxuXHRuYW1lPzogc3RyaW5nLFxyXG5cclxuXHRiYXNlbmFtZT86IHN0cmluZyxcclxuXHRleHQ/OiBzdHJpbmcsXHJcblx0bWltZT86IHN0cmluZyxcclxuXHRkYXRhPztcclxuXHJcblx0aXM/OiBzdHJpbmcsXHJcblx0aHJlZj86IHN0cmluZyxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQ29sbGVjdGlvblxyXG57XHJcblx0bmFtZT86IHN0cmluZyxcclxuXHR0eXBlPzogc3RyaW5nLFxyXG5cdHBvc2l0aW9uPzogbnVtYmVyLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElFcHViQ29uZmlnXHJcbntcclxuXHR1dWlkPzogc3RyaW5nO1xyXG5cdHRlbXBsYXRlTmFtZT86IHN0cmluZztcclxuXHJcblx0ZmlsZW5hbWU/OiBzdHJpbmc7XHJcblxyXG5cdHRpdGxlPzogc3RyaW5nO1xyXG5cdHRpdGxlX3Nob3J0Pzogc3RyaW5nLFxyXG5cdHRpdGxlcz86IHN0cmluZ1tdO1xyXG5cclxuXHRzbHVnPzogc3RyaW5nO1xyXG5cclxuXHRsYW5nPzogc3RyaW5nO1xyXG5cclxuXHRhdXRob3I/OiBzdHJpbmc7XHJcblx0YXV0aG9yVXJsPzogc3RyaW5nO1xyXG5cdGF1dGhvcnM/OiB7XHJcblx0XHRbaW5kZXg6IHN0cmluZ106IHN0cmluZyxcclxuXHR9O1xyXG5cdGF1dGhvcnNKU09OPzogc3RyaW5nO1xyXG5cclxuXHRwdWJsaXNoZXI/OiBzdHJpbmc7XHJcblxyXG5cdHJpZ2h0cz86IElSaWdodHNDb25maWc7XHJcblxyXG5cdGNvdmVyPzogSUNvdmVyO1xyXG5cdGN3ZD86IHN0cmluZztcclxuXHJcblx0aWRlbnRpZmllcnM/OiBzdHJpbmdbXTtcclxuXHJcblx0YXR0cmlidXRpb25Vcmw/OiBzdHJpbmc7XHJcblx0c3R5bGVzaGVldD86IElTdHlsZXNoZWV0O1xyXG5cdHNlY3Rpb25zPzogRXB1Yk1ha2VyLlNlY3Rpb25bXTtcclxuXHR0b2M/OiBFcHViTWFrZXIuU2VjdGlvbltdO1xyXG5cdGxhbmRtYXJrcz86IEVwdWJNYWtlci5TZWN0aW9uW107XHJcblx0b3B0aW9ucz87XHJcblx0YWRkaXRpb25hbEZpbGVzPzogSUZpbGVzW107XHJcblxyXG5cdG1vZGlmaWNhdGlvbj86IG1vbWVudC5Nb21lbnQ7XHJcblx0bW9kaWZpY2F0aW9uRGF0ZT86IHN0cmluZztcclxuXHRtb2RpZmljYXRpb25EYXRlWU1EPzogc3RyaW5nO1xyXG5cdHB1YmxpY2F0aW9uPzogbW9tZW50Lk1vbWVudDtcclxuXHRwdWJsaWNhdGlvbkRhdGU/OiBzdHJpbmc7XHJcblx0cHVibGljYXRpb25EYXRlWU1EPzogc3RyaW5nO1xyXG5cclxuXHQvKipcclxuXHQgKiA8bWV0YSBwcm9wZXJ0eT1cImJlbG9uZ3MtdG8tY29sbGVjdGlvblwiIGlkPVwiaWQtMlwiPum7kuOBrumtlOeOi1dFQjwvbWV0YT5cclxuXHQgKiA8bWV0YSByZWZpbmVzPVwiI2lkLTJcIiBwcm9wZXJ0eT1cImNvbGxlY3Rpb24tdHlwZVwiPnNlcmllczwvbWV0YT5cclxuXHQgKiA8bWV0YSByZWZpbmVzPVwiI2lkLTJcIiBwcm9wZXJ0eT1cImdyb3VwLXBvc2l0aW9uXCI+MTwvbWV0YT5cclxuXHQgKi9cclxuXHRjb2xsZWN0aW9uPzogSUNvbGxlY3Rpb247XHJcblxyXG5cdC8qKlxyXG5cdCAqIDxkYzpzdWJqZWN0PlxyXG5cdCAqL1xyXG5cdHRhZ3M/OiBzdHJpbmdbXTtcclxuXHJcblx0aW5mb1ByZWZhY2U/OiBzdHJpbmc7XHJcblx0aW5mb1ByZWZhY2VIVE1MPzogc3RyaW5nO1xyXG5cclxuXHRsaW5rcz86IEVwdWJNZXRhTGlua1tdLFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEVwdWJNZXRhTGlua1xyXG57XHJcblx0aHJlZjogc3RyaW5nLFxyXG5cdHJlbDogc3RyaW5nLFxyXG5cdGlkPzogc3RyaW5nLFxyXG5cdHJlZmluZXM6IHN0cmluZyxcclxuXHQnbWVkaWEtdHlwZSc6IHN0cmluZyxcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEVwdWJDb25maWcgaW1wbGVtZW50cyBJRXB1YkNvbmZpZ1xyXG57XHJcblx0dXVpZD86IHN0cmluZztcclxuXHR0ZW1wbGF0ZU5hbWU/OiBzdHJpbmc7XHJcblxyXG5cdGZpbGVuYW1lPzogc3RyaW5nO1xyXG5cclxuXHR0aXRsZT86IHN0cmluZztcclxuXHR0aXRsZV9zaG9ydD86IHN0cmluZztcclxuXHJcblx0dGl0bGVzPzogc3RyaW5nW107XHJcblxyXG5cdHNsdWc/OiBzdHJpbmc7XHJcblxyXG5cdGxhbmc/OiBzdHJpbmc7XHJcblxyXG5cdGF1dGhvcj86IHN0cmluZztcclxuXHRhdXRob3JVcmw/OiBzdHJpbmc7XHJcblx0YXV0aG9ycz86IHtcclxuXHRcdFtpbmRleDogc3RyaW5nXTogc3RyaW5nLFxyXG5cdH07XHJcblx0YXV0aG9yc0pTT04/OiBzdHJpbmc7XHJcblxyXG5cdHB1Ymxpc2hlcj86IHN0cmluZztcclxuXHJcblx0cmlnaHRzPzogSVJpZ2h0c0NvbmZpZztcclxuXHJcblx0Y292ZXI/OiBJQ292ZXI7XHJcblx0Y3dkPzogc3RyaW5nO1xyXG5cclxuXHRpZGVudGlmaWVycz86IHN0cmluZ1tdO1xyXG5cclxuXHRhdHRyaWJ1dGlvblVybD86IHN0cmluZztcclxuXHRzdHlsZXNoZWV0PzogSVN0eWxlc2hlZXQ7XHJcblx0c2VjdGlvbnM/OiBFcHViTWFrZXIuU2VjdGlvbltdO1xyXG5cdHRvYz86IEVwdWJNYWtlci5TZWN0aW9uW107XHJcblx0bGFuZG1hcmtzPzogRXB1Yk1ha2VyLlNlY3Rpb25bXTtcclxuXHRvcHRpb25zPzoge1xyXG5cdFx0bGliU2x1Z2lmeT86IElTbHVnaWZ5LFxyXG5cdFx0ZXh0Pzogc3RyaW5nLFxyXG5cdFx0Z2VuZXJhdGVPcHRpb25zPyxcclxuXHR9O1xyXG5cdGFkZGl0aW9uYWxGaWxlcz86IElGaWxlc1tdO1xyXG5cclxuXHRtb2RpZmljYXRpb24/OiBtb21lbnQuTW9tZW50O1xyXG5cdG1vZGlmaWNhdGlvbkRhdGU/OiBzdHJpbmc7XHJcblx0bW9kaWZpY2F0aW9uRGF0ZVlNRD86IHN0cmluZztcclxuXHRwdWJsaWNhdGlvbj86IG1vbWVudC5Nb21lbnQ7XHJcblx0cHVibGljYXRpb25EYXRlPzogc3RyaW5nO1xyXG5cdHB1YmxpY2F0aW9uRGF0ZVlNRD86IHN0cmluZztcclxuXHJcblx0LyoqXHJcblx0ICogPG1ldGEgcHJvcGVydHk9XCJiZWxvbmdzLXRvLWNvbGxlY3Rpb25cIiBpZD1cImlkLTJcIj7pu5Ljga7prZTnjotXRUI8L21ldGE+XHJcblx0ICogPG1ldGEgcmVmaW5lcz1cIiNpZC0yXCIgcHJvcGVydHk9XCJjb2xsZWN0aW9uLXR5cGVcIj5zZXJpZXM8L21ldGE+XHJcblx0ICogPG1ldGEgcmVmaW5lcz1cIiNpZC0yXCIgcHJvcGVydHk9XCJncm91cC1wb3NpdGlvblwiPjE8L21ldGE+XHJcblx0ICovXHJcblx0Y29sbGVjdGlvbj86IElDb2xsZWN0aW9uO1xyXG5cclxuXHQvKipcclxuXHQgKiA8ZGM6c3ViamVjdD5cclxuXHQgKi9cclxuXHR0YWdzPzogc3RyaW5nW107XHJcblxyXG5cdGluZm9QcmVmYWNlPzogc3RyaW5nO1xyXG5cdGluZm9QcmVmYWNlSFRNTD86IHN0cmluZztcclxuXHJcblx0bGlua3M/OiBFcHViTWV0YUxpbmtbXTtcclxuXHJcblx0Y29uc3RydWN0b3IoZXB1YkNvbmZpZzogSUVwdWJDb25maWcgPSB7fSwgb3B0aW9uczogYW55ID0ge30pXHJcblx0e1xyXG5cdFx0aWYgKGVwdWJDb25maWcgaW5zdGFuY2VvZiBFcHViQ29uZmlnKVxyXG5cdFx0e1xyXG5cdFx0XHRlcHViQ29uZmlnID0gZXB1YkNvbmZpZy5lbnRyaWVzKGZhbHNlKTtcclxuXHJcblx0XHRcdGRlbGV0ZSBlcHViQ29uZmlnLnNsdWc7XHJcblx0XHRcdGRlbGV0ZSBlcHViQ29uZmlnLnV1aWQ7XHJcblx0XHR9XHJcblxyXG5cdFx0T2JqZWN0LmFzc2lnbih0aGlzLCBFcHViQ29uZmlnLmdldERlZmF1bHRFcHViQ29uZmlnKCksIGRlZXBtZXJnZS5hbGwoW3t9LCBlcHViQ29uZmlnLCB7XHJcblx0XHRcdG9wdGlvbnNcclxuXHRcdH1dLCBkZWVwbWVyZ2VPcHRpb25zKSk7XHJcblx0fVxyXG5cclxuXHRnZXQgbGFuZ01haW4oKVxyXG5cdHtcclxuXHRcdHJldHVybiB0aGlzLmxhbmc7XHJcblx0fVxyXG5cclxuXHRnZXQgc3ViamVjdHMoKTogc3RyaW5nW11cclxuXHR7XHJcblx0XHRyZXR1cm4gdGhpcy50YWdzO1xyXG5cdH1cclxuXHJcblx0c2V0IHN1YmplY3RzKHZhbDogc3RyaW5nW10pXHJcblx0e1xyXG5cdFx0dGhpcy50YWdzID0gdmFsO1xyXG5cdH1cclxuXHJcblx0c2V0TW9kaWZpY2F0aW9uKHZhbCwgLi4uYXJndilcclxuXHR7XHJcblx0XHRsZXQgZGF0YTtcclxuXHJcblx0XHRpZiAodmFsID09PSB0cnVlKVxyXG5cdFx0e1xyXG5cdFx0XHRkYXRhID0gbW9tZW50KCk7XHJcblx0XHR9XHJcblx0XHRlbHNlXHJcblx0XHR7XHJcblx0XHRcdGRhdGEgPSBtb21lbnQodmFsLCAuLi5hcmd2KTtcclxuXHRcdH1cclxuXHJcblx0XHRsZXQgc2VsZiA9IHRoaXMgYXMgSUVwdWJDb25maWc7XHJcblx0XHRzZWxmLm1vZGlmaWNhdGlvbiA9IGRhdGEubG9jYWwoKTtcclxuXHJcblx0XHRyZXR1cm4gdGhpcztcclxuXHR9XHJcblxyXG5cdHNldFB1YmxpY2F0aW9uKHZhbCwgLi4uYXJndilcclxuXHR7XHJcblx0XHRsZXQgZGF0YTtcclxuXHJcblx0XHRpZiAodmFsID09PSB0cnVlKVxyXG5cdFx0e1xyXG5cdFx0XHRkYXRhID0gbW9tZW50KCk7XHJcblx0XHR9XHJcblx0XHRlbHNlXHJcblx0XHR7XHJcblx0XHRcdGRhdGEgPSBtb21lbnQodmFsLCAuLi5hcmd2KTtcclxuXHRcdH1cclxuXHJcblx0XHRsZXQgc2VsZiA9IHRoaXMgYXMgSUVwdWJDb25maWc7XHJcblx0XHRzZWxmLnB1YmxpY2F0aW9uID0gZGF0YS5sb2NhbCgpO1xyXG5cclxuXHRcdHJldHVybiB0aGlzO1xyXG5cdH1cclxuXHJcblx0YWRkQXV0aG9yKG5hbWU6IHN0cmluZywgdXJsOiBzdHJpbmcgPSBudWxsKVxyXG5cdHtcclxuXHRcdGlmICghbmFtZSlcclxuXHRcdHtcclxuXHRcdFx0dGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCk7XHJcblx0XHR9XHJcblxyXG5cdFx0bGV0IHNlbGYgPSB0aGlzIGFzIElFcHViQ29uZmlnO1xyXG5cclxuXHRcdHNlbGYuYXV0aG9ycyA9IHNlbGYuYXV0aG9ycyB8fCB7fTtcclxuXHJcblx0XHRzZWxmLmF1dGhvcnNbbmFtZV0gPSB1cmw7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRhZGRMaW5rKGRhdGE6IEVwdWJNZXRhTGluayB8IHN0cmluZywgcmVsPzogc3RyaW5nKVxyXG5cdHtcclxuXHRcdHJlbCA9IChyZWwgfHwgKDxFcHViTWV0YUxpbms+ZGF0YSkucmVsKSBhcyBzdHJpbmc7XHJcblxyXG5cdFx0aWYgKHR5cGVvZiBkYXRhID09ICdzdHJpbmcnKVxyXG5cdFx0e1xyXG5cdFx0XHRkYXRhID0ge1xyXG5cdFx0XHRcdGhyZWY6IGRhdGEudG9TdHJpbmcoKSxcclxuXHRcdFx0XHRyZWwsXHJcblx0XHRcdH0gYXMgRXB1Yk1ldGFMaW5rO1xyXG5cdFx0fVxyXG5cclxuXHRcdGxldCBsaW5rID0gT2JqZWN0LmFzc2lnbih7XHJcblx0XHRcdGhyZWY6ICcnLFxyXG5cdFx0XHRyZWw6ICcnLFxyXG5cdFx0XHRpZDogJycsXHJcblx0XHRcdHJlZmluZXM6ICcnLFxyXG5cdFx0XHQnbWVkaWEtdHlwZSc6ICcnLFxyXG5cdFx0fSBhcyBFcHViTWV0YUxpbmssIGRhdGEpO1xyXG5cclxuXHRcdGxpbmsuaHJlZiA9IChsaW5rLmhyZWYgfHwgZGF0YS5ocmVmIHx8ICcnKS50b1N0cmluZygpO1xyXG5cdFx0bGluay5yZWwgPSBsaW5rLnJlbCB8fCByZWwgfHwgZGF0YS5yZWwgfHwgJ2xpbmstJyArIHNob3J0aWQoKTtcclxuXHJcblx0XHR0aGlzLmxpbmtzID0gdGhpcy5saW5rcyB8fCBbXTtcclxuXHRcdHRoaXMubGlua3MucHVzaChsaW5rKTtcclxuXHJcblx0XHRyZXR1cm4gdGhpcztcclxuXHR9XHJcblxyXG5cdC8qKlxyXG5cdCAqIGlzYm46eHh4XHJcblx0ICogY2FsaWJyZTp4eHhcclxuXHQgKiB1dWlkOnh4eFxyXG5cdCAqXHJcblx0ICogQHBhcmFtIHtzdHJpbmd9IHR5cGVcclxuXHQgKiBAcGFyYW0ge3N0cmluZ30gaWRcclxuXHQgKiBAcmV0dXJucyB7dGhpc31cclxuXHQgKi9cclxuXHRhZGRJZGVudGlmaWVyKHR5cGU6IHN0cmluZywgaWQ/OiBzdHJpbmcpXHJcblx0e1xyXG5cdFx0dGhpcy5pZGVudGlmaWVycyA9IHRoaXMuaWRlbnRpZmllcnMgfHwgW107XHJcblxyXG5cdFx0bGV0IGlkcyA9IFtdO1xyXG5cclxuXHRcdGlmICh0eXBlICYmIHR5cGUgIT09ICcnKVxyXG5cdFx0e1xyXG5cdFx0XHRpZHMucHVzaCh0eXBlLnRvU3RyaW5nKCkpO1xyXG5cdFx0fVxyXG5cdFx0aWYgKGlkICYmIGlkICE9PSAnJylcclxuXHRcdHtcclxuXHRcdFx0aWRzLnB1c2goaWQudG9TdHJpbmcoKSk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKCFpZHMubGVuZ3RoKVxyXG5cdFx0e1xyXG5cdFx0XHR0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoKTtcclxuXHRcdH1cclxuXHJcblx0XHR0aGlzLmlkZW50aWZpZXJzLnB1c2goaWRzLmpvaW4oJzonKSk7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHQkY2xvbmUoKVxyXG5cdHtcclxuXHRcdC8vIEB0cy1pZ25vcmVcclxuXHRcdHJldHVybiBuZXcgKHRoaXMuX19wcm90b19fLmNvbnN0cnVjdG9yKSh0aGlzKTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyAkY3JlYXRlKGVwdWJDb25maWc6IElFcHViQ29uZmlnID0ge30sIG9wdGlvbnM6IGFueSA9IHt9KVxyXG5cdHtcclxuXHRcdHJldHVybiBuZXcgdGhpcyhlcHViQ29uZmlnLCBvcHRpb25zKVxyXG5cdH1cclxuXHJcblx0JGF1dG8oKVxyXG5cdHtcclxuXHRcdGxldCBzZWxmID0gdGhpcyBhcyBJRXB1YkNvbmZpZztcclxuXHJcblx0XHRzZWxmLnRhZ3MgPSBzZWxmLnRhZ3MgfHwgW107XHJcblxyXG5cdFx0W1xyXG5cdFx0XHRzZWxmLnRhZ3MsXHJcblx0XHRdLmZvckVhY2goYSA9PiAoYSB8fCBbXSkuZmlsdGVyKHYgPT4gdikubWFwKHYgPT4gdi50b1N0cmluZygpKSk7XHJcblxyXG5cdFx0e1xyXG5cdFx0XHRpZiAoc2VsZi5hdXRob3JzKVxyXG5cdFx0XHR7XHJcblx0XHRcdFx0c2VsZi5hdXRob3IgPSBzZWxmLmF1dGhvciB8fCBPYmplY3Qua2V5cyhzZWxmLmF1dGhvcnMpWzBdO1xyXG5cdFx0XHRcdHNlbGYuYXV0aG9yVXJsID0gc2VsZi5hdXRob3JVcmwgfHwgc2VsZi5hdXRob3JzW3NlbGYuYXV0aG9yXTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aWYgKHNlbGYuYXV0aG9yKVxyXG5cdFx0XHR7XHJcblx0XHRcdFx0bGV0IG8gPSB7fTtcclxuXHJcblx0XHRcdFx0b1tzZWxmLmF1dGhvcl0gPSAoc2VsZi5hdXRob3JVcmwgfHwgJycpLnRvU3RyaW5nKCk7XHJcblxyXG5cdFx0XHRcdHNlbGYuYXV0aG9ycyA9IE9iamVjdC5hc3NpZ24obywgc2VsZi5hdXRob3JzLCBvKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0aWYgKHNlbGYuYXV0aG9ycyAmJiBPYmplY3Qua2V5cyhzZWxmLmF1dGhvcnMpLmxlbmd0aClcclxuXHRcdFx0e1xyXG5cdFx0XHRcdGZvciAobGV0IG5hbWUgaW4gc2VsZi5hdXRob3JzKVxyXG5cdFx0XHRcdHtcclxuXHRcdFx0XHRcdHNlbGYuYXV0aG9yc1tuYW1lXSA9IChzZWxmLmF1dGhvcnNbbmFtZV0gfHwgJycpLnRvU3RyaW5nKCk7XHJcblxyXG5cdFx0XHRcdFx0c2VsZi50YWdzLnB1c2gobmFtZSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRzZWxmLmF1dGhvcnNKU09OID0gSlNPTi5zdHJpbmdpZnkoc2VsZi5hdXRob3JzKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlXHJcblx0XHRcdHtcclxuXHRcdFx0XHRzZWxmLmF1dGhvcnMgPSBudWxsO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHNlbGYucHVibGlzaGVyKVxyXG5cdFx0e1xyXG5cdFx0XHRzZWxmLnRhZ3MucHVzaChzZWxmLnB1Ymxpc2hlcik7XHJcblx0XHR9XHJcblx0XHRlbHNlXHJcblx0XHR7XHJcblx0XHRcdHNlbGYucHVibGlzaGVyID0gJ2VwdWItbWFrZXIyJztcclxuXHRcdH1cclxuXHJcblx0XHR7XHJcblx0XHRcdHNlbGYudGFncy5wdXNoKCdlcHViLW1ha2VyMicpO1xyXG5cclxuXHRcdFx0aWYgKHNlbGYudGFncylcclxuXHRcdFx0e1xyXG5cdFx0XHRcdHNlbGYudGFncyA9IGFycmF5X3VuaXF1ZShzZWxmLnRhZ3MpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHNlbGYudGl0bGVzKVxyXG5cdFx0e1xyXG5cdFx0XHRzZWxmLnRpdGxlcyA9IHNlbGYudGl0bGVzLmZpbHRlcih2ID0+IHYgJiYgdiAhPSBzZWxmLnRpdGxlICYmIHYgIT0gc2VsZi50aXRsZV9zaG9ydCk7XHJcblxyXG5cdFx0XHRzZWxmLnRpdGxlcyA9IGFycmF5X3VuaXF1ZShzZWxmLnRpdGxlcyk7XHJcblx0XHR9XHJcblxyXG5cdFx0c2VsZi51dWlkID0gKHNlbGYudXVpZCAmJiB0eXBlb2Ygc2VsZi51dWlkID09ICdzdHJpbmcnKSA/IHNlbGYudXVpZCA6IGNyZWF0ZVVVSUQoc2VsZik7XHJcblx0XHRzZWxmLnNsdWcgPSBzZWxmLnNsdWdcclxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxyXG5cdFx0XHR8fCBzbHVnaWZ5KHNlbGYudGl0bGUpXHJcblx0XHRcdHx8IGhhc2hTdW0oc2VsZi50aXRsZSlcclxuXHRcdDtcclxuXHJcblx0XHRpZiAoIXNlbGYubW9kaWZpY2F0aW9uKVxyXG5cdFx0e1xyXG5cdFx0XHRzZWxmLm1vZGlmaWNhdGlvbiA9IHNlbGYucHVibGljYXRpb24uY2xvbmUoKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoc2VsZi5tb2RpZmljYXRpb24pXHJcblx0XHR7XHJcblx0XHRcdHNlbGYubW9kaWZpY2F0aW9uRGF0ZSA9IHNlbGYubW9kaWZpY2F0aW9uLmZvcm1hdCgnWVlZWS1NTS1ERFRoaDptbTpzcycpICsgJ1onO1xyXG5cdFx0XHRzZWxmLm1vZGlmaWNhdGlvbkRhdGVZTUQgPSBzZWxmLm1vZGlmaWNhdGlvbi5mb3JtYXQoJ1lZWVktTU0tREQnKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoIXNlbGYucHVibGljYXRpb24pXHJcblx0XHR7XHJcblx0XHRcdHRoaXMuc2V0UHVibGljYXRpb24odHJ1ZSk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHNlbGYuaW5mb1ByZWZhY2UpXHJcblx0XHR7XHJcblx0XHRcdC8qXHJcblx0XHRcdHNlbGYuaW5mb1ByZWZhY2UgPSBjcmxmKHNlbGYuaW5mb1ByZWZhY2UpLnJlcGxhY2UoL1sgXFx0XFx1RkVGRlxceEEw44CAXSskL2dtLCAnJyk7XHJcblxyXG5cdFx0XHRzZWxmLmluZm9QcmVmYWNlSFRNTCA9IHNlbGYuaW5mb1ByZWZhY2VIVE1MIHx8IHNlbGYuaW5mb1ByZWZhY2UucmVwbGFjZSgvXFxuL2csICc8YnIvPicpXHJcblx0XHRcdCovXHJcblx0XHRcdGh0bWxQcmVmYWNlKHNlbGYpO1xyXG5cdFx0fVxyXG5cclxuXHRcdC8vY29uc29sZS5sb2coc2VsZi5pbmZvUHJlZmFjZSwgc2VsZi5pbmZvUHJlZmFjZUhUTUwpO1xyXG5cclxuXHRcdHNlbGYucHVibGljYXRpb25EYXRlID0gc2VsZi5wdWJsaWNhdGlvbi5mb3JtYXQoRXB1YkNvbmZpZy5kYXRlRm9ybWF0KTtcclxuXHRcdHNlbGYucHVibGljYXRpb25EYXRlWU1EID0gc2VsZi5wdWJsaWNhdGlvbi5mb3JtYXQoJ1lZWVktTU0tREQnKTtcclxuXHJcblx0XHRpZiAoc2VsZi5jb2xsZWN0aW9uIHx8IDEpXHJcblx0XHR7XHJcblx0XHRcdHNlbGYuY29sbGVjdGlvbi5uYW1lID0gc2VsZi5jb2xsZWN0aW9uLm5hbWUgfHwgc2VsZi50aXRsZTtcclxuXHRcdFx0c2VsZi5jb2xsZWN0aW9uLnBvc2l0aW9uID0gc2VsZi5jb2xsZWN0aW9uLnBvc2l0aW9uIHx8IDE7XHJcblx0XHRcdHNlbGYuY29sbGVjdGlvbi50eXBlID0gc2VsZi5jb2xsZWN0aW9uLnR5cGUgfHwgJ3Nlcmllcyc7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRlbnRyaWVzKGF1dG8gPSB0cnVlKTogSUVwdWJDb25maWdcclxuXHR7XHJcblx0XHRpZiAoYXV0bylcclxuXHRcdHtcclxuXHRcdFx0dGhpcy4kYXV0bygpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBPYmplY3QuZW50cmllcyh0aGlzKVxyXG5cdFx0XHQucmVkdWNlKGZ1bmN0aW9uIChhLCBiKVxyXG5cdFx0XHR7XHJcblx0XHRcdFx0YVtiWzBdXSA9IGJbMV07XHJcblxyXG5cdFx0XHRcdHJldHVybiBhO1xyXG5cdFx0XHR9LCB7fSlcclxuXHRcdDtcclxuXHR9XHJcblxyXG5cdHRvSlNPTihhdXRvPzogYm9vbGVhbiwgcmVwbGFjZXIgPSBudWxsLCBzcGFjZSA9IFwiXFx0XCIpOiBzdHJpbmdcclxuXHR7XHJcblx0XHRpZiAoYXV0bylcclxuXHRcdHtcclxuXHRcdFx0dGhpcy4kYXV0bygpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLmVudHJpZXMoKSwgcmVwbGFjZXIsIHNwYWNlKTtcclxuXHR9XHJcblxyXG5cdHRvQXJyYXkoYXV0bz86IGJvb2xlYW4pXHJcblx0e1xyXG5cdFx0aWYgKGF1dG8pXHJcblx0XHR7XHJcblx0XHRcdHRoaXMuJGF1dG8oKTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gT2JqZWN0LmVudHJpZXModGhpcyk7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgbmFtZXNwYWNlIEVwdWJDb25maWdcclxue1xyXG5cdGV4cG9ydCBsZXQgZGF0ZUZvcm1hdCA9ICdZWVlZLU1NLUREVEhIOm1tOnNzLlNTU1onO1xyXG5cclxuXHRleHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdEVwdWJDb25maWcoKVxyXG5cdHtcclxuXHRcdHJldHVybiB7XHJcblx0XHRcdHRvYzogW10sXHJcblx0XHRcdGxhbmRtYXJrczogW10sXHJcblx0XHRcdHNlY3Rpb25zOiBbXSxcclxuXHRcdFx0c3R5bGVzaGVldDoge30sXHJcblx0XHRcdGFkZGl0aW9uYWxGaWxlczogW10sXHJcblx0XHRcdG9wdGlvbnM6IHt9LFxyXG5cdFx0fTtcclxuXHR9XHJcblxyXG5cdGV4cG9ydCBsZXQgZGVmYXVsdEVwdWJDb25maWcgPSBnZXREZWZhdWx0RXB1YkNvbmZpZygpO1xyXG59XHJcblxyXG4vL2xldCBhID0gbmV3IEVwdWJDb25maWcoe2xhbmc6ICd6aCd9KTtcclxuLy9cclxuLy9hLmFkZEF1dGhvcign6I+x5b2x5Luj55CGJyk7XHJcbi8vXHJcbi8vYS5zZXRQdWJsaWNhdGlvbih0cnVlKTtcclxuLy9cclxuLy9sZXQgYiA9IG5ldyBFcHViQ29uZmlnKGEpO1xyXG4vL1xyXG4vL2EubGFuZyA9ICdqcCc7XHJcbi8vXHJcbi8vY29uc29sZS5sb2coYSwgYi4kYXV0bygpKTtcclxuXHJcbi8vIEB0cy1pZ25vcmVcclxuZXhwb3J0IGRlZmF1bHQgRXB1YkNvbmZpZyBhcyBFcHViQ29uZmlnO1xyXG4iXX0=