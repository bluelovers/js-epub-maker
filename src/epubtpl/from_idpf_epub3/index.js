"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const zip_1 = require("../../epubtpl-lib/zip");
const handlebar_helpers_1 = require("../../epubtpl-lib/handlebar-helpers");
const ajax_1 = require("../../epubtpl-lib/ajax");
const path = require("path");
const epubtpl_lib_1 = require("../../epubtpl-lib");
// @ts-ignore
exports.EPUB_TEMPLATES_PATH = path.join(__dirname);
exports.EPUB_TEMPLATES_TPL = path.join(exports.EPUB_TEMPLATES_PATH, 'tpl');
let templates = {
    mimetype: 'mimetype',
    container: 'META-INF/container.xml',
    opf: 'EPUB/wasteland.opf',
    ncx: 'EPUB/wasteland.ncx',
    nav: 'EPUB/wasteland-nav.xhtml',
    css: 'EPUB/wasteland.css',
    content: 'EPUB/wasteland-content.xhtml',
    sectionsTemplate: 'EPUB/sections-template.xhtml',
};
for (let i in templates) {
    templates[i] = `\{\{import \'${path.join(exports.EPUB_TEMPLATES_TPL, templates[i])}'\}\}`;
}
let Builder = function () {
    this.make = function (epubConfig, options) {
        console.debug('building epub', epubConfig);
        let zip = new zip_1.JSZip();
        return Promise
            .all([
            zip_1.default.addMimetype(zip, epubConfig, options),
            zip_1.default.addContainerInfo(zip, epubConfig, options),
            addManifestOpf(zip, epubConfig, options),
            zip_1.default.addCover(zip, epubConfig, options),
            addEpub2Nav(zip, epubConfig, options),
            addEpub3Nav(zip, epubConfig, options),
            addStylesheets(zip, epubConfig, options),
            addContent(zip, epubConfig, options)
        ])
            .then(function () {
            return zip;
        });
    };
    function addManifestOpf(zip, epubConfig, options) {
        zip.folder('EPUB').file(epubConfig.slug + '.opf', handlebar_helpers_1.compileTpl(templates.opf, epubConfig));
    }
    function addEpub2Nav(zip, epubConfig, options) {
        zip.folder('EPUB').file(epubConfig.slug + '.ncx', handlebar_helpers_1.compileTpl(templates.ncx, epubConfig));
    }
    function addEpub3Nav(zip, epubConfig, options) {
        zip.folder('EPUB').file(epubConfig.slug + '-nav.xhtml', handlebar_helpers_1.compileTpl(templates.nav, epubConfig));
    }
    async function addStylesheets(zip, epubConfig, options) {
        if (epubConfig.stylesheet.url) {
            return ajax_1.ajax(epubConfig.stylesheet.url).then(function (result) {
                epubConfig.styles = result.data;
                return compileAndAddCss();
            });
        }
        return compileAndAddCss();
        async function compileAndAddCss() {
            let styles = {
                original: epubConfig.stylesheet.replaceOriginal ? '' : options.templates.css,
                custom: epubConfig.styles || '',
            };
            let css = await handlebar_helpers_1.compileTpl(`${styles.original}\n${styles.custom}`, styles, true);
            css = await epubtpl_lib_1.default.compileCss(css);
            await zip.folder('EPUB')
                .folder('css')
                .file('main.css', css);
            return true;
        }
    }
    function addContent(zip, epubConfig, options) {
        handlebar_helpers_1.Handlebars.registerPartial('sectionTemplate', templates.sectionsTemplate);
        zip.folder('EPUB').file(epubConfig.slug + '-content.xhtml', handlebar_helpers_1.compileTpl(templates.content, epubConfig));
    }
};
exports.builder = new Builder();
exports.default = exports.builder;
if (typeof window !== 'undefined') {
    // @ts-ignore
    window.epubMaker = exports.builder;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtDQUFrRTtBQUNsRSwyRUFBNkU7QUFDN0UsaURBQThDO0FBQzlDLDZCQUE2QjtBQUU3QixtREFBK0M7QUFFL0MsYUFBYTtBQUNBLFFBQUEsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQVcsQ0FBQztBQUNyRCxRQUFBLGtCQUFrQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQW1CLEVBQUUsS0FBSyxDQUFXLENBQUM7QUFFbEYsSUFBSSxTQUFTLEdBQUc7SUFDZixRQUFRLEVBQUUsVUFBVTtJQUNwQixTQUFTLEVBQUUsd0JBQXdCO0lBQ25DLEdBQUcsRUFBRSxvQkFBb0I7SUFDekIsR0FBRyxFQUFFLG9CQUFvQjtJQUN6QixHQUFHLEVBQUUsMEJBQTBCO0lBQy9CLEdBQUcsRUFBRSxvQkFBb0I7SUFDekIsT0FBTyxFQUFFLDhCQUE4QjtJQUN2QyxnQkFBZ0IsRUFBRSw4QkFBOEI7Q0FDaEQsQ0FBQztBQUVGLEtBQUssSUFBSSxDQUFDLElBQUksU0FBUyxFQUN2QjtJQUNDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxnQkFBZ0IsSUFBSSxDQUFDLElBQUksQ0FBQywwQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0NBQ2xGO0FBRUQsSUFBSSxPQUFPLEdBQUc7SUFHYixJQUFJLENBQUMsSUFBSSxHQUFHLFVBQXFCLFVBQXVCLEVBQUUsT0FBUTtRQUVqRSxPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUMzQyxJQUFJLEdBQUcsR0FBRyxJQUFJLFdBQUssRUFBRSxDQUFDO1FBRXRCLE9BQU8sT0FBTzthQUNaLEdBQUcsQ0FBQztZQUNKLGFBQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUM7WUFDNUMsYUFBTSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDO1lBQ2pELGNBQWMsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQztZQUN4QyxhQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDO1lBQ3pDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQztZQUNyQyxXQUFXLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUM7WUFDckMsY0FBYyxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDO1lBQ3hDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQztTQUNwQyxDQUFDO2FBQ0QsSUFBSSxDQUFDO1lBRUwsT0FBTyxHQUFHLENBQUM7UUFDWixDQUFDLENBQUMsQ0FFRDtJQUNILENBQUMsQ0FBQztJQUVGLFNBQVMsY0FBYyxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsT0FBTztRQUUvQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxHQUFHLE1BQU0sRUFBRSw4QkFBVSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMxRixDQUFDO0lBRUQsU0FBUyxXQUFXLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxPQUFPO1FBRTVDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsTUFBTSxFQUFFLDhCQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQzFGLENBQUM7SUFFRCxTQUFTLFdBQVcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLE9BQU87UUFFNUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxZQUFZLEVBQUUsOEJBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVELEtBQUssVUFBVSxjQUFjLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxPQUFPO1FBRXJELElBQUksVUFBVSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQzdCO1lBQ0MsT0FBTyxXQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxNQUFNO2dCQUUzRCxVQUFVLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBRWhDLE9BQU8sZ0JBQWdCLEVBQUUsQ0FBQztZQUMzQixDQUFDLENBQUMsQ0FBQztTQUNIO1FBRUQsT0FBTyxnQkFBZ0IsRUFBRSxDQUFDO1FBRTFCLEtBQUssVUFBVSxnQkFBZ0I7WUFFOUIsSUFBSSxNQUFNLEdBQUc7Z0JBQ1osUUFBUSxFQUFFLFVBQVUsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRztnQkFDNUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLElBQUksRUFBRTthQUMvQixDQUFDO1lBRUYsSUFBSSxHQUFHLEdBQUcsTUFBTSw4QkFBVSxDQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRWpGLEdBQUcsR0FBRyxNQUFNLHFCQUFVLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRXZDLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7aUJBQ3RCLE1BQU0sQ0FBQyxLQUFLLENBQUM7aUJBQ2IsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FDdEI7WUFFRCxPQUFPLElBQUksQ0FBQztRQUNiLENBQUM7SUFDRixDQUFDO0lBRUQsU0FBUyxVQUFVLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxPQUFPO1FBRTNDLDhCQUFVLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsZ0JBQWdCLEVBQUUsOEJBQVUsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDeEcsQ0FBQztBQUVGLENBQUMsQ0FBQztBQUVXLFFBQUEsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7QUFDckMsa0JBQWUsZUFBTyxDQUFDO0FBRXZCLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUNqQztJQUNDLGFBQWE7SUFDYixNQUFNLENBQUMsU0FBUyxHQUFHLGVBQU8sQ0FBQztDQUMzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElCdWlsZGVyLCBJQnVpbGRlckNhbGxiYWNrLCBJRXB1YkNvbmZpZyB9IGZyb20gJy4uLy4uL3Zhcic7XG5pbXBvcnQgemlwTGliLCB7IEpTWmlwLCBKU1ppcFV0aWxzIH0gZnJvbSAnLi4vLi4vZXB1YnRwbC1saWIvemlwJztcbmltcG9ydCB7IEhhbmRsZWJhcnMsIGNvbXBpbGVUcGwgfSBmcm9tICcuLi8uLi9lcHVidHBsLWxpYi9oYW5kbGViYXItaGVscGVycyc7XG5pbXBvcnQgeyBhamF4IH0gZnJvbSAnLi4vLi4vZXB1YnRwbC1saWIvYWpheCc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgZXB1YlRwbExpYiwge30gZnJvbSAnLi4vLi4vZXB1YnRwbC1saWInO1xuXG4vLyBAdHMtaWdub3JlXG5leHBvcnQgY29uc3QgRVBVQl9URU1QTEFURVNfUEFUSCA9IHBhdGguam9pbihfX2Rpcm5hbWUpIGFzIHN0cmluZztcbmV4cG9ydCBjb25zdCBFUFVCX1RFTVBMQVRFU19UUEwgPSBwYXRoLmpvaW4oRVBVQl9URU1QTEFURVNfUEFUSCwgJ3RwbCcpIGFzIHN0cmluZztcblxubGV0IHRlbXBsYXRlcyA9IHtcblx0bWltZXR5cGU6ICdtaW1ldHlwZScsXG5cdGNvbnRhaW5lcjogJ01FVEEtSU5GL2NvbnRhaW5lci54bWwnLFxuXHRvcGY6ICdFUFVCL3dhc3RlbGFuZC5vcGYnLFxuXHRuY3g6ICdFUFVCL3dhc3RlbGFuZC5uY3gnLFxuXHRuYXY6ICdFUFVCL3dhc3RlbGFuZC1uYXYueGh0bWwnLFxuXHRjc3M6ICdFUFVCL3dhc3RlbGFuZC5jc3MnLFxuXHRjb250ZW50OiAnRVBVQi93YXN0ZWxhbmQtY29udGVudC54aHRtbCcsXG5cdHNlY3Rpb25zVGVtcGxhdGU6ICdFUFVCL3NlY3Rpb25zLXRlbXBsYXRlLnhodG1sJyxcbn07XG5cbmZvciAobGV0IGkgaW4gdGVtcGxhdGVzKVxue1xuXHR0ZW1wbGF0ZXNbaV0gPSBgXFx7XFx7aW1wb3J0IFxcJyR7cGF0aC5qb2luKEVQVUJfVEVNUExBVEVTX1RQTCwgdGVtcGxhdGVzW2ldKX0nXFx9XFx9YDtcbn1cblxubGV0IEJ1aWxkZXIgPSBmdW5jdGlvbiAoKVxue1xuXG5cdHRoaXMubWFrZSA9IGZ1bmN0aW9uIDxUID0gSlNaaXA+KGVwdWJDb25maWc6IElFcHViQ29uZmlnLCBvcHRpb25zPyk6IFByb21pc2U8VD5cblx0e1xuXHRcdGNvbnNvbGUuZGVidWcoJ2J1aWxkaW5nIGVwdWInLCBlcHViQ29uZmlnKTtcblx0XHRsZXQgemlwID0gbmV3IEpTWmlwKCk7XG5cblx0XHRyZXR1cm4gUHJvbWlzZVxuXHRcdFx0LmFsbChbXG5cdFx0XHRcdHppcExpYi5hZGRNaW1ldHlwZSh6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpLFxuXHRcdFx0XHR6aXBMaWIuYWRkQ29udGFpbmVySW5mbyh6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpLFxuXHRcdFx0XHRhZGRNYW5pZmVzdE9wZih6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpLFxuXHRcdFx0XHR6aXBMaWIuYWRkQ292ZXIoemlwLCBlcHViQ29uZmlnLCBvcHRpb25zKSxcblx0XHRcdFx0YWRkRXB1YjJOYXYoemlwLCBlcHViQ29uZmlnLCBvcHRpb25zKSxcblx0XHRcdFx0YWRkRXB1YjNOYXYoemlwLCBlcHViQ29uZmlnLCBvcHRpb25zKSxcblx0XHRcdFx0YWRkU3R5bGVzaGVldHMoemlwLCBlcHViQ29uZmlnLCBvcHRpb25zKSxcblx0XHRcdFx0YWRkQ29udGVudCh6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpXG5cdFx0XHRdKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHppcDtcblx0XHRcdH0pXG5cdFx0XHQvLy5jYXRjaChlcnIgPT4gY29uc29sZS5sb2coZXJyKSlcblx0XHRcdDtcblx0fTtcblxuXHRmdW5jdGlvbiBhZGRNYW5pZmVzdE9wZih6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpXG5cdHtcblx0XHR6aXAuZm9sZGVyKCdFUFVCJykuZmlsZShlcHViQ29uZmlnLnNsdWcgKyAnLm9wZicsIGNvbXBpbGVUcGwodGVtcGxhdGVzLm9wZiwgZXB1YkNvbmZpZykpO1xuXHR9XG5cblx0ZnVuY3Rpb24gYWRkRXB1YjJOYXYoemlwLCBlcHViQ29uZmlnLCBvcHRpb25zKVxuXHR7XG5cdFx0emlwLmZvbGRlcignRVBVQicpLmZpbGUoZXB1YkNvbmZpZy5zbHVnICsgJy5uY3gnLCBjb21waWxlVHBsKHRlbXBsYXRlcy5uY3gsIGVwdWJDb25maWcpKTtcblx0fVxuXG5cdGZ1bmN0aW9uIGFkZEVwdWIzTmF2KHppcCwgZXB1YkNvbmZpZywgb3B0aW9ucylcblx0e1xuXHRcdHppcC5mb2xkZXIoJ0VQVUInKS5maWxlKGVwdWJDb25maWcuc2x1ZyArICctbmF2LnhodG1sJywgY29tcGlsZVRwbCh0ZW1wbGF0ZXMubmF2LCBlcHViQ29uZmlnKSk7XG5cdH1cblxuXHRhc3luYyBmdW5jdGlvbiBhZGRTdHlsZXNoZWV0cyh6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpXG5cdHtcblx0XHRpZiAoZXB1YkNvbmZpZy5zdHlsZXNoZWV0LnVybClcblx0XHR7XG5cdFx0XHRyZXR1cm4gYWpheChlcHViQ29uZmlnLnN0eWxlc2hlZXQudXJsKS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpXG5cdFx0XHR7XG5cdFx0XHRcdGVwdWJDb25maWcuc3R5bGVzID0gcmVzdWx0LmRhdGE7XG5cblx0XHRcdFx0cmV0dXJuIGNvbXBpbGVBbmRBZGRDc3MoKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHJldHVybiBjb21waWxlQW5kQWRkQ3NzKCk7XG5cblx0XHRhc3luYyBmdW5jdGlvbiBjb21waWxlQW5kQWRkQ3NzKClcblx0XHR7XG5cdFx0XHRsZXQgc3R5bGVzID0ge1xuXHRcdFx0XHRvcmlnaW5hbDogZXB1YkNvbmZpZy5zdHlsZXNoZWV0LnJlcGxhY2VPcmlnaW5hbCA/ICcnIDogb3B0aW9ucy50ZW1wbGF0ZXMuY3NzLFxuXHRcdFx0XHRjdXN0b206IGVwdWJDb25maWcuc3R5bGVzIHx8ICcnLFxuXHRcdFx0fTtcblxuXHRcdFx0bGV0IGNzcyA9IGF3YWl0IGNvbXBpbGVUcGwoYCR7c3R5bGVzLm9yaWdpbmFsfVxcbiR7c3R5bGVzLmN1c3RvbX1gLCBzdHlsZXMsIHRydWUpO1xuXG5cdFx0XHRjc3MgPSBhd2FpdCBlcHViVHBsTGliLmNvbXBpbGVDc3MoY3NzKTtcblxuXHRcdFx0YXdhaXQgemlwLmZvbGRlcignRVBVQicpXG5cdFx0XHRcdC5mb2xkZXIoJ2NzcycpXG5cdFx0XHRcdC5maWxlKCdtYWluLmNzcycsIGNzcylcblx0XHRcdDtcblxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXHR9XG5cblx0ZnVuY3Rpb24gYWRkQ29udGVudCh6aXAsIGVwdWJDb25maWcsIG9wdGlvbnMpXG5cdHtcblx0XHRIYW5kbGViYXJzLnJlZ2lzdGVyUGFydGlhbCgnc2VjdGlvblRlbXBsYXRlJywgdGVtcGxhdGVzLnNlY3Rpb25zVGVtcGxhdGUpO1xuXHRcdHppcC5mb2xkZXIoJ0VQVUInKS5maWxlKGVwdWJDb25maWcuc2x1ZyArICctY29udGVudC54aHRtbCcsIGNvbXBpbGVUcGwodGVtcGxhdGVzLmNvbnRlbnQsIGVwdWJDb25maWcpKTtcblx0fVxuXG59O1xuXG5leHBvcnQgY29uc3QgYnVpbGRlciA9IG5ldyBCdWlsZGVyKCk7XG5leHBvcnQgZGVmYXVsdCBidWlsZGVyO1xuXG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0d2luZG93LmVwdWJNYWtlciA9IGJ1aWxkZXI7XG59XG4iXX0=