{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["import zipLib, { JSZip } from '../../epubtpl-lib/zip';\nimport { compileTpl, Handlebars } from '../../epubtpl-lib/handlebar-helpers';\nimport { fetchFile } from '../../epubtpl-lib/ajax';\nimport { compileCss } from '../../epubtpl-lib/postcss';\nimport path = require('path');\nimport { IBuilder } from '../../var';\nimport { EpubMaker } from '../../index';\nimport { BPromise, shortid } from '../../lib/util';\nimport { EnumEpubConfigVertical } from '../../config';\n\nexport const EPUB_TEMPLATES_PATH = path.join(__dirname) as string;\nexport const EPUB_TEMPLATES_TPL = path.join(EPUB_TEMPLATES_PATH, 'tpl') as string;\n\ndeclare module '../../index'\n{\n\tnamespace EpubMaker\n\t{\n\t\tinterface Section\n\t\t{\n\t\t\tneedPage: boolean;\n\t\t\tname: string;\n\n\t\t\trank: number | string;\n\t\t}\n\t}\n}\n\nexport namespace Builder\n{\n\texport let templates = {\n\t\t//mimetype: 'mimetype',\n\t\t//container: 'META-INF/container.xml',\n\t\topf: 'EPUB/content.opf',\n\t\tncx: 'EPUB/toc.ncx',\n\t\tnav: 'EPUB/nav.xhtml',\n\t\tcss: 'EPUB/css/main.css',\n\t\tcontent: 'EPUB/content.xhtml',\n\t\tautoToc: 'EPUB/auto-toc.xhtml',\n\t\tsectionsNavTemplate: 'EPUB/sections-nav-template.html',\n\t\tsectionsNCXTemplate: 'EPUB/sections-ncx-template.xml',\n\t\tsectionsOPFManifestTemplate: 'EPUB/sections-opf-manifest-template.xml',\n\t\tsectionsOPFSpineTemplate: 'EPUB/sections-opf-spine-template.xml',\n\n\t\tcoverPage: 'EPUB/CoverPage.xhtml',\n\t\ttableOfContents: 'EPUB/TableOfContents.xhtml',\n\n\t\tsectionsInfo: 'EPUB/sections-info.html',\n\t\tsectionsScript: 'EPUB/sections-script.html',\n\n\t\tcontents: 'EPUB/contents.xhtml',\n\t};\n\n\tfor (let i in templates)\n\t{\n\t\ttemplates[i] = `\\{\\{import \\'${path.join(EPUB_TEMPLATES_TPL, templates[i])}'\\}\\}`;\n\t}\n\n\tlet playOrder = 0;\n\n\texport let staticFiles = {\n\t\t'mimetype': 'mimetype',\n\t\t'META-INF/container.xml': 'META-INF/container.xml',\n\t};\n\n\tfor (let i in staticFiles)\n\t{\n\t\tstaticFiles[i] = path.join(EPUB_TEMPLATES_TPL, staticFiles[i]);\n\t}\n\n\texport function make(epub: EpubMaker, options?): BPromise<JSZip>\n\t{\n\t\t//let epubConfig = epub.epubConfig;\n\n\t\toptions = Object.assign({}, {\n\t\t\ttemplates: templates,\n\t\t}, options);\n\n\t\t//console.debug('[building epub]', epub.epubConfig);\n\t\t//console.debug('[building epub]', options);\n\t\tlet zip = new JSZip();\n\n\t\t//await addAditionalInfo(zip, epub, options);\n\n\t\tHandlebars.registerPartial('sectionsInfo', options.templates.sectionsInfo);\n\t\tHandlebars.registerPartial('sectionsScript', options.templates.sectionsScript);\n\n\t\treturn BPromise\n\t\t\t.mapSeries([\n\t\t\t\taddStaticFiles,\n\n\t\t\t\taddAditionalInfo,\n\n\t\t\t\t//zipLib.addMimetype,\n\t\t\t\t//zipLib.addContainerInfo,\n\t\t\t\taddCover,\n\n\t\t\t\tzipLib.addFiles,\n\n\t\t\t\taddStylesheets,\n\t\t\t\taddManifestOpf,\n\t\t\t\taddEpub2Nav,\n\t\t\t\taddEpub3Nav,\n\t\t\t\taddContent,\n\n\t\t\t\ttableOfContents,\n\t\t\t], async function (fn, index)\n\t\t\t{\n\t\t\t\tif (fn === zipLib.addFiles)\n\t\t\t\t{\n\t\t\t\t\treturn (fn as typeof zipLib.addFiles)(zip, epub, options)\n\t\t\t\t\t\t.then(function (ls)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn ls;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t}\n\n\t\t\t\treturn fn(zip, epub, options);\n\t\t\t})\n\t\t\t.tap(function ()\n\t\t\t{\n\t\t\t\t//console.log(epub.epubConfig.cover);\n\t\t\t})\n\t\t\t.then(function ()\n\t\t\t{\n\t\t\t\treturn zip;\n\t\t\t})\n\t\t\t//.catch(err => console.log(err))\n\t\t\t;\n\t}\n\n\texport function addStaticFiles(zip, epub: EpubMaker, options)\n\t{\n\t\tlet ls = Object.keys(staticFiles).reduce(function (a, key)\n\t\t{\n\t\t\tlet b = {\n\t\t\t\tname: key,\n\t\t\t\text: '',\n\t\t\t\tfile: staticFiles[key],\n\t\t\t};\n\n\t\t\ta.push(b);\n\n\t\t\treturn a;\n\t\t}, []);\n\n\t\treturn zipLib.addStaticFiles(zip, ls);\n\t}\n\n\texport async function tableOfContents(zip, epub: EpubMaker, options)\n\t{\n\t\tzip\n\t\t\t.folder('EPUB')\n\t\t\t.file('TableOfContents.xhtml', compileTpl(options.templates.tableOfContents, epub.epubConfig))\n\t\t;\n\n\t\tzip\n\t\t\t.folder('EPUB')\n\t\t\t.file('contents.xhtml', compileTpl(options.templates.contents, epub.epubConfig))\n\t\t;\n\t}\n\n\texport async function addCover(zip, epub: EpubMaker, options)\n\t{\n\t\tlet bool = await zipLib.addCover(zip, epub, options);\n\n\t\tif (bool)\n\t\t{\n\t\t\tzip\n\t\t\t\t.folder('EPUB')\n\t\t\t\t.file('CoverPage.xhtml', compileTpl(options.templates.coverPage, epub.epubConfig))\n\t\t\t;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tepub.epubConfig.cover = null;\n\t\t}\n\t}\n\n\texport function addInfoSection(section, titlePrefix?, namePrefix?)\n\t{\n\t\tlet c = '_';\n\n\t\tif (!section.content)\n\t\t{\n\t\t\tsection.content = {};\n\t\t}\n\t\tif (titlePrefix)\n\t\t{\n\t\t\ttitlePrefix = section.content.fullTitle = titlePrefix + ' - ' + section.content.title;\n\t\t\tnamePrefix = section.name = namePrefix + c + section.rank;\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttitlePrefix = section.content.fullTitle = section.content.title;\n\t\t\tnamePrefix = section.name = section.rank;\n\t\t}\n\t\tif (section.content.content || section.content.renderTitle || section.epubType == 'auto-toc')\n\t\t{\n\t\t\tsection.needPage = true;\n\t\t}\n\n\t\tsection.playOrder = playOrder++;\n\n\t\tif (!section.id)\n\t\t{\n\t\t\tsection.id = (section.epubType || '').toString().replace('/\\W/g', '') + shortid();\n\t\t}\n\n\t\tfor (let i = 0; i < section.subSections.length; i++)\n\t\t{\n\t\t\tsection.subSections[i].rank = i.toString().padStart(3, '0');\n\t\t\taddInfoSection(section.subSections[i], titlePrefix, namePrefix);\n\t\t}\n\t}\n\n\texport function addAditionalInfo(zip, epub: EpubMaker, options)\n\t{\n\t\t//Default options\n\t\t// @ts-ignore\n\t\tepub.epubConfig.options.tocName = epub.epubConfig.options.tocName || 'Menu';\n\t\t//Generate name and full title for each section/subsection\n\t\tfor (let i = 0; i < epub.epubConfig.sections.length; i++)\n\t\t{\n\t\t\tepub.epubConfig.sections[i].rank = i.toString().padStart(3, '0');\n\t\t\taddInfoSection(epub.epubConfig.sections[i]);\n\t\t}\n\t}\n\n\texport function addManifestOpf(zip, epub: EpubMaker, options)\n\t{\n\t\tHandlebars.registerPartial('sectionsOPFManifestTemplate', options.templates.sectionsOPFManifestTemplate);\n\t\tHandlebars.registerPartial('sectionsOPFSpineTemplate', options.templates.sectionsOPFSpineTemplate);\n\n\t\tzip.folder('EPUB').file('content.opf', compileTpl(options.templates.opf, epub.epubConfig));\n\t}\n\n\texport function addEpub2Nav(zip, epub: EpubMaker, options)\n\t{\n\t\tHandlebars.registerPartial('sectionsNCXTemplate', options.templates.sectionsNCXTemplate);\n\t\tzip.folder('EPUB').file('toc.ncx', compileTpl(options.templates.ncx, epub.epubConfig));\n\t}\n\n\texport function addEpub3Nav(zip, epub: EpubMaker, options)\n\t{\n\t\tHandlebars.registerPartial('sectionsNavTemplate', options.templates.sectionsNavTemplate);\n\t\tzip.folder('EPUB').file('nav.xhtml', compileTpl(options.templates.nav, epub.epubConfig));\n\t}\n\n\texport async function addStylesheets(zip, epub: EpubMaker, options)\n\t{\n\t\tif (epub.epubConfig.vertical === EnumEpubConfigVertical.VERTICAL_RL)\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\tconst fs = require('fs') as typeof import('fs');\n\n\t\t\t\tlet data = fs.readFileSync(path.join(__dirname, './tpl/EPUB/css/vertical-rl.css'));\n\n\t\t\t\tlet file = await fetchFile({\n\t\t\t\t\tdata,\n\t\t\t\t});\n\n\t\t\t\tepub.epubConfig.stylesheet.styles += \"\\n\" + file.data.toString();\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t\tconsole.error(e);\n\t\t\t}\n\t\t}\n\n\t\tif (epub.epubConfig.stylesheet.url || epub.epubConfig.stylesheet.file)\n\t\t{\n\t\t\tlet file = await fetchFile(epub.epubConfig.stylesheet);\n\n\t\t\tepub.epubConfig.stylesheet.styles += \"\\n\" + file.data.toString();\n\t\t}\n\n\t\treturn compileAndAddCss();\n\n\t\tasync function compileAndAddCss()\n\t\t{\n\t\t\tlet styles = {\n\t\t\t\toriginal: epub.epubConfig.stylesheet.replaceOriginal ? '' : options.templates.css,\n\t\t\t\tcustom: epub.epubConfig.stylesheet.styles || '',\n\t\t\t};\n\n\t\t\tlet css = await compileTpl(`${styles.original}\\n${styles.custom}`, styles, true);\n\n\t\t\tcss = await compileCss(css);\n\n\t\t\treturn zip.folder('EPUB')\n\t\t\t\t.folder('css')\n\t\t\t\t.file('main.css', css)\n\t\t\t\t;\n\t\t}\n\t}\n\n\texport function addSection(zip: JSZip, section: EpubMaker.Section, epub: EpubMaker, options)\n\t{\n\t\treturn zipLib.addSubSections(zip, section, function (zip, section, epubConfig, options)\n\t\t{\n\t\t\tif (section.needPage)\n\t\t\t{\n\t\t\t\tlet name = section.name + '.xhtml';\n\n\t\t\t\tif (section.epubType == 'auto-toc')\n\t\t\t\t{\n\t\t\t\t\treturn zip\n\t\t\t\t\t\t.folder('EPUB')\n\t\t\t\t\t\t.file(name, compileTpl(options.templates.autoToc, section))\n\t\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn zip\n\t\t\t\t\t\t.folder('EPUB')\n\t\t\t\t\t\t.file(name, compileTpl(options.templates.content, section))\n\t\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}, epub, options);\n\t}\n\n\texport function addContent(zip, epub: EpubMaker, options)\n\t{\n\t\treturn BPromise.mapSeries(epub.epubConfig.sections, function (section)\n\t\t{\n\t\t\treturn addSection(zip, section, epub, options);\n\t\t});\n\t}\n}\n\n// @ts-ignore\nexport const builder = Builder as IBuilder;\nexport default builder as IBuilder;\n\n/*\nif (typeof window !== 'undefined')\n{\n\t// @ts-ignore\n\twindow.epubMaker = builder;\n}\n*/\n"]}